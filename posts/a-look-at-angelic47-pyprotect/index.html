<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.70.0" />

    
    
    

<title>A Look at Angelic47&#39;s PyProtect • Ando&#39;s thoughts</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A Look at Angelic47&#39;s PyProtect"/>
<meta name="twitter:description" content="A dive into the inner-workings of Angelic47&rsquo;s Python 2.7 protector, PyProtect."/>

<meta property="og:title" content="A Look at Angelic47&#39;s PyProtect" />
<meta property="og:description" content="A dive into the inner-workings of Angelic47&rsquo;s Python 2.7 protector, PyProtect." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://andoryuuta.github.io/posts/a-look-at-angelic47-pyprotect/" />
<meta property="article:published_time" content="2019-11-02T12:49:29-07:00" />
<meta property="article:modified_time" content="2019-11-02T12:49:29-07:00" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">











<link rel="stylesheet" href="/scss/hyde-hyde.0c332b9e355ca8aeb89a85a141e0fef3729fc7dfee2a15bbc4023db98adb56f6.css" >


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.0873834b0f2e9fdc9e1d0301e8ebce21fc10383882a41e9373f29b90e85a9987.css" integrity="sha256-CHODSw8un9yeHQMB6OvOIfwQODiCpB6Tc/KbkOhamYc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="http://andoryuuta.github.io/">Ando&#39;s thoughts</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="http://andoryuuta.github.io/img/avatar.png" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Ando&#39;s thoughts</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/portfolio/">
						<span>Portfolio</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/AndoryuuRE" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/Andoryuuta" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2020 Andrew Gutekanst
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>A Look at Angelic47&#39;s PyProtect</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Nov 02, 2019
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 22 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a>
      <ul>
        <li><a href="#goals">Goals</a></li>
        <li><a href="#our-starting-point">Our starting point</a></li>
      </ul>
    </li>
    <li><a href="#stage-1">Stage 1</a></li>
    <li><a href="#stage-2">Stage 2</a></li>
    <li><a href="#stage-3">Stage 3</a></li>
    <li><a href="#postface">Postface</a>
      <ul>
        <li><a href="#resources">Resources</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <hr>
<h2 id="preface">Preface</h2>
<p>English is my first and only language, but that does not mean that I&rsquo;m good at using it. I apologize if this post does not convey information clearly or concisely.</p>
<p><a href="https://pyprotect.angelic47.com/">PyProtect</a> is a Python 2.7 protector made by <a href="https://github.com/Angelic47">Angelic47</a>. Its main feature is an obfuscated bytecode wrapper that prevents decompilers and disassemblers from working normally. The website also claims that it uses &ldquo;&hellip; irreversible destructive techniques to prevent direct source capture&rdquo; (Google Translated).</p>
<p>I recently came across something using PyProtect and decied to document my path towards writing an unpacker for it.</p>
<p>I should note that, while searching for existing information about PyProtect, I came across an <a href="https://snowstar.org/2019/05/09/pyprotect-by-angelic47-decode/">extremely informative Chinese article written by <code>Snowstar</code></a>. Although this post has slightly different goals, it mostly rehashes and expands upon things mentioned in that article. As such, it would be no stretch to say that <!-- raw HTML omitted -->this post is primarily based on, and is perhaps a derivative work of, the article written by <code>Snowstar</code><!-- raw HTML omitted -->.</p>
<h3 id="goals">Goals</h3>
<p>I set some (perhaps unusual) goals/constraints for myself while working on this.</p>
<ol>
<li>
<p><!-- raw HTML omitted -->Do everything from Python 3<!-- raw HTML omitted -->*</p>
<p>All of the previous articles I&rsquo;ve seen about python bytecode obfuscation require dropping down to the same interpreter version as the targeted bytecode so that the <a href="https://docs.python.org/3/library/dis.html"><code>dis</code></a>, <a href="https://docs.python.org/3/library/marshal.html"><code>marshal</code></a>, or <a href="https://github.com/fireeye/flare-bytecode_graph"><code>flare-bytecode_graph</code></a> modules work. Because of this, I wanted to make sure that the techniques/libraries used in this article run in Python 3, regardless of the target bytecode version.</p>
</li>
<li>
<p><!-- raw HTML omitted -->Decompile each stage<!-- raw HTML omitted --></p>
<p>Although this might not be possible for hand-written bytecode, the protection stages from PyProtect <em>seem</em> to be normally compiled python bytecode, with slight modifications to prevent decompilation. As such, it should be possible to get decompiled code from each protection stage, including the original python example code.</p>
</li>
<li>
<p><!-- raw HTML omitted -->Run only known code.<!-- raw HTML omitted --></p>
<p>Unlike the <code>Snowstar</code> article mentioned above, I wanted to avoid ever calling into unknown code objects, and instead reverse engineer the logic and reimplement it myself. This is to minimize the chances of malicious code running if somebody uses my code on an unknown PyProtected file.</p>
</li>
</ol>
<p><!-- raw HTML omitted -->* Except testing the PyProtected file.<!-- raw HTML omitted --></p>
<h3 id="our-starting-point">Our starting point</h3>
<p>To start, we will be using a known example script that uses an import, class, class method, function, etc to see how PyProtect manipulates things.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#f92672">import</span> random

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Human</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, name, age):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>age <span style="color:#f92672">=</span> age

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">have_birthday</span>(self):
        self<span style="color:#f92672">.</span>age <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Happy birthday {}!&#34;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>name))


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_adult</span>(human):
    <span style="color:#66d9ef">return</span> human<span style="color:#f92672">.</span>age <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">21</span>

<span style="color:#75715e"># Make some humans.</span>
humans <span style="color:#f92672">=</span> [
    Human(<span style="color:#e6db74">&#34;Aarav&#34;</span>, <span style="color:#ae81ff">17</span>),
    Human(<span style="color:#e6db74">&#34;Jane&#34;</span>, <span style="color:#ae81ff">19</span>),
    Human(<span style="color:#e6db74">&#34;Yoshi&#34;</span>, <span style="color:#ae81ff">27</span>),
    Human(<span style="color:#e6db74">&#34;Günay&#34;</span>, <span style="color:#ae81ff">20</span>),
    Human(<span style="color:#e6db74">&#34;Cody&#34;</span>, <span style="color:#ae81ff">17</span>)
]

<span style="color:#75715e"># Then let one die each year.</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">5</span>):
    <span style="color:#66d9ef">for</span> human <span style="color:#f92672">in</span> humans:
        human<span style="color:#f92672">.</span>have_birthday()

    <span style="color:#75715e"># Randomly kill one.</span>
    human <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice(humans)
    classification <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;adult&#34;</span> <span style="color:#66d9ef">if</span> is_adult(human) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;minor&#34;</span>
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;{} died as a {} at the age of {}.&#34;</span><span style="color:#f92672">.</span>format(human<span style="color:#f92672">.</span>name, classification, human<span style="color:#f92672">.</span>age))
    humans<span style="color:#f92672">.</span>remove(human)

</code></pre></div><p>After passing that through PyProtect, we are provided a .pyc file that still runs normally in the CPython 2.7 interpreter.
<img src="image1.png" alt=".pyc file running normally"></p>
<p>If we take a quick look at the PyProtected file with a hex editor, we&rsquo;ll see that we now have a neat little header.
<img src="image5.png" alt="pyprotect header"></p>
<p>Or if formatted properly (GBK / CP936 encoding):</p>
<pre><code>==========================================================================================
本文件由PyProtect加密 - PyProtect: 在线Python文件加密器
https://pyprotect.angelic47.com
==========================================================================================
</code></pre><p>Further, all traces of our original variable names are gone as well.
<img src="image2.png" alt=".pyc under hex editor"></p>
<h2 id="stage-1">Stage 1</h2>
<p>First off, we try to run <code>uncompyle6</code> to verify that PyProtect has actually done anything to prevent it from working.
<img src="image3.png" alt="unhelpful uncompyle6 errors"></p>
<p>If we look at the crash, we can see the error is actually coming from <code>xdis</code>, the python-version-agnostic sister project of <code>uncompyle6</code> that provides stable <code>dis</code> and <code>marshal</code> functionally across Python versions.</p>
<p>To verify that this is an problem dissassembling with <code>xdis</code>, rather than an issue with <code>uncompyle6</code>, we try to disassemble the code ourselves, and we&rsquo;ll end up getting the same error:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> xdis.load <span style="color:#f92672">import</span> load_module
<span style="color:#f92672">import</span> xdis<span style="color:#f92672">,</span> xdis.main

(version, timestamp, magic_int, co2, pypy, source_size) <span style="color:#f92672">=</span> load_module(<span style="color:#e6db74">&#39;my_test_script.pyc&#39;</span>)
xdis<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>disco(version, co2, timestamp)
</code></pre></div><p><img src="image4.png" alt="unhelpful xdis errors">
Now that we know this is an issue within <code>xdis</code>, we can start looking at the bytecode.</p>
<p>The <code>co2.co_code</code> variable contains the bytecode that the interpreter will use upon starting. So for this <code>.pyc</code> to be runnable, at least the first instruction should be valid, so let&rsquo;s check that.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> xdis.load <span style="color:#f92672">import</span> load_module
<span style="color:#f92672">from</span> xdis.bytecode <span style="color:#f92672">import</span> get_instructions_bytes
<span style="color:#f92672">import</span> xdis<span style="color:#f92672">,</span> xdis.main

(version, timestamp, magic_int, co2, pypy, source_size) <span style="color:#f92672">=</span> load_module(<span style="color:#e6db74">&#39;my_test_script.pyc&#39;</span>)

<span style="color:#75715e"># Get the opcode data for this bytecode version</span>
opc <span style="color:#f92672">=</span> xdis<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>get_opcode(version, pypy)

<span style="color:#75715e"># Take one instruction from the python generator.</span>
inst <span style="color:#f92672">=</span> next(get_instructions_bytes(co2<span style="color:#f92672">.</span>co_code, opc))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{}: {} {}&#39;</span><span style="color:#f92672">.</span>format(inst<span style="color:#f92672">.</span>offset, inst<span style="color:#f92672">.</span>opname, inst<span style="color:#f92672">.</span>argval))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">0: JUMP_FORWARD <span style="color:#ae81ff">44</span>
</code></pre></div><p>Yep, that looks like like a normal instruction. How about the next few?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">0: JUMP_FORWARD <span style="color:#ae81ff">44</span>
3: DELETE_GLOBAL <span style="color:#ae81ff">47658</span>
6: &lt;215&gt; <span style="color:#ae81ff">4248</span>
9: ROT_TWO None
10: &lt;182&gt; <span style="color:#ae81ff">64653</span>
13: &lt;191&gt; <span style="color:#ae81ff">51992</span>
16: &lt;249&gt; <span style="color:#ae81ff">39482</span>
19: &lt;224&gt; <span style="color:#ae81ff">24838</span>
22: &lt;175&gt; <span style="color:#ae81ff">54593</span>
25: &lt;190&gt; <span style="color:#ae81ff">50426</span>
</code></pre></div><p>Those look less normal (and might even crash in <code>xdis</code> when trying to disassemble them, depending on what data has been placed there).</p>
<p>What happened here is that the bytecode has been prefixed with a <code>JUMP_FORWARD</code> instruction pointing to the original first instruction, and some junk data to mess with the disassembler. Because <code>xdis</code> uses a linear sweep algorithm (that is it expects each instruction to follow the previous, regardless of control flow instructions), it occasionally breaks when the junk data can be disassembled as a real instruction, but which accesses something invalid (e.g. a very high const index which doesn&rsquo;t exist in <code>co2.co_consts</code>). This is a common anti-disassembly technique for all linear sweep disassemblers.</p>
<p>To work around this, we could try to delete the first <code>n</code> bytes up to the jump target offset, but that will shift all of the bytecode offsets backwards, breaking any instrutions that use an absolute offset. Instead, a better option is to replace the bytes with <code>NOP</code> instructions so that the offsets stay the same.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> xdis.load <span style="color:#f92672">import</span> load_module
<span style="color:#f92672">from</span> xdis.bytecode <span style="color:#f92672">import</span> get_instructions_bytes
<span style="color:#f92672">import</span> xdis<span style="color:#f92672">,</span> xdis.main

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">nop_start_jump_junk</span>(co, opc):
    jmp_inst <span style="color:#f92672">=</span> next(get_instructions_bytes(co<span style="color:#f92672">.</span>co_code, opc))
    target <span style="color:#f92672">=</span> jmp_inst<span style="color:#f92672">.</span>argval

    <span style="color:#75715e"># Make a copy of the co_code and copy the bytecode over,</span>
    <span style="color:#75715e"># replacing everything up to the jump target with `NOP` instructions.</span>
    fixed_code <span style="color:#f92672">=</span> bytearray(len(co<span style="color:#f92672">.</span>co_code))
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(co<span style="color:#f92672">.</span>co_code)):
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> target:
            fixed_code[i] <span style="color:#f92672">=</span> opc<span style="color:#f92672">.</span>opmap[<span style="color:#e6db74">&#39;NOP&#39;</span>]
        <span style="color:#66d9ef">else</span>:
            fixed_code[i] <span style="color:#f92672">=</span> co<span style="color:#f92672">.</span>co_code[i]
    
    <span style="color:#75715e"># Set fixed code back on co2.</span>
    co<span style="color:#f92672">.</span>co_code <span style="color:#f92672">=</span> fixed_code
    co<span style="color:#f92672">.</span>freeze()

(version, timestamp, magic_int, co2, pypy, source_size) <span style="color:#f92672">=</span> load_module(<span style="color:#e6db74">&#39;my_test_script.pyc&#39;</span>)
opc <span style="color:#f92672">=</span> xdis<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>get_opcode(version, pypy)
nop_start_jump_junk(co2, opc)
inst_gen <span style="color:#f92672">=</span> get_instructions_bytes(co2<span style="color:#f92672">.</span>co_code, opc)

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">175</span>):
    inst <span style="color:#f92672">=</span> next(inst_gen)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{}: {} {}&#39;</span><span style="color:#f92672">.</span>format(inst<span style="color:#f92672">.</span>offset, inst<span style="color:#f92672">.</span>opname, inst<span style="color:#f92672">.</span>argval))
</code></pre></div><p>After doing that, we now get normal looking instructions after the NOPs until around ~<code>339</code>, where it seems to have another anti-disassembly jump with some junk unary ops and constantly repeating <code>DELETE_SUBSCR</code>.</p>
<pre><code>0: NOP None
1: NOP None
2: NOP None
... snip ...
41: NOP None
42: NOP None
43: NOP None
44: SETUP_EXCEPT 308
47: LOAD_CONST 0
50: LOAD_CONST 1
53: IMPORT_NAME 0
56: STORE_NAME 0
59: LOAD_CONST 0
62: LOAD_CONST 1
... snip ...
314: PRINT_ITEM None
315: PRINT_NEWLINE None
316: JUMP_FORWARD 320
319: END_FINALLY None
320: LOAD_NAME 22
323: STORE_NAME 21
326: DELETE_NAME 21
329: LOAD_CONST 1
332: RETURN_VALUE None
333: EXTENDED_ARG 0
336: JUMP_FORWARD 1646 # &lt;-- Jump far beyond of all these `DELETE_SUBSCR`.
339: UNARY_CONVERT None
340: UNARY_POSITIVE None
341: UNARY_CONVERT None
342: UNARY_POSITIVE None
343: DELETE_SUBSCR None
344: DELETE_SUBSCR None
345: DELETE_SUBSCR None
346: DELETE_SUBSCR None
347: DELETE_SUBSCR None
348: DELETE_SUBSCR None
349: DELETE_SUBSCR None
350: DELETE_SUBSCR None
351: DELETE_SUBSCR None
352: DELETE_SUBSCR None
353: DELETE_SUBSCR None
</code></pre><p>However, if we print some of the data starting at ~339, we&rsquo;ll find that the data actually seems to be real text.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">print</span>(co2<span style="color:#f92672">.</span>co_code[<span style="color:#ae81ff">339</span>:<span style="color:#ae81ff">350</span>])
bytearray(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">=======&#39;</span>)
</code></pre></div><p>Another quick look in our hex editor again and we see that is actually the neat little header we saw at the beginning.</p>
<p><img src="image5.png" alt="pyprotect header"></p>
<p>By abusing this known header value, we easily find the second anti-disassembly jump and replace it with <code>NOP</code> instructions also:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> xdis.load <span style="color:#f92672">import</span> load_module
<span style="color:#f92672">from</span> xdis.bytecode <span style="color:#f92672">import</span> get_instructions_bytes, instruction_size
<span style="color:#f92672">import</span> xdis<span style="color:#f92672">,</span> xdis.main

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">nop_jump_junk</span>(co, opc):
    <span style="color:#75715e"># Get the first jump target.</span>
    first_jump_inst <span style="color:#f92672">=</span> next(get_instructions_bytes(co<span style="color:#f92672">.</span>co_code, opc))
    first_jump_target <span style="color:#f92672">=</span> first_jump_inst<span style="color:#f92672">.</span>argval

    <span style="color:#75715e"># Abuse the text header to find the second jump.</span>
    header_start_target <span style="color:#f92672">=</span> co<span style="color:#f92672">.</span>co_code<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">========&#39;</span>)
    jump_forward_inst_size <span style="color:#f92672">=</span> instruction_size(opc<span style="color:#f92672">.</span>opmap[<span style="color:#e6db74">&#39;JUMP_FORWARD&#39;</span>], opc)
    second_jump_start <span style="color:#f92672">=</span> header_start_target<span style="color:#f92672">-</span>jump_forward_inst_size <span style="color:#75715e"># Offset to the start of the JUMP_FORWARD, right before the header.</span>
    second_jump_inst <span style="color:#f92672">=</span> next(get_instructions_bytes(co<span style="color:#f92672">.</span>co_code[second_jump_start:second_jump_start<span style="color:#f92672">+</span>jump_forward_inst_size], opc))
    second_jump_target <span style="color:#f92672">=</span> second_jump_start <span style="color:#f92672">+</span> second_jump_inst<span style="color:#f92672">.</span>argval <span style="color:#75715e"># JUMP_FORWARD is relative, so we need to add the offset.</span>

    <span style="color:#75715e"># Make a copy of the co_code and replace the jump and junk bytes with NOP.</span>
    fixed_code <span style="color:#f92672">=</span> bytearray(len(co<span style="color:#f92672">.</span>co_code))
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(co<span style="color:#f92672">.</span>co_code)):
        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> first_jump_target) <span style="color:#f92672">or</span> (i <span style="color:#f92672">&gt;=</span> second_jump_start<span style="color:#f92672">+</span>jump_forward_inst_size <span style="color:#f92672">and</span> i <span style="color:#f92672">&lt;</span> second_jump_target) :
            fixed_code[i] <span style="color:#f92672">=</span> opc<span style="color:#f92672">.</span>opmap[<span style="color:#e6db74">&#39;NOP&#39;</span>]
        <span style="color:#66d9ef">else</span>:
            fixed_code[i] <span style="color:#f92672">=</span> co<span style="color:#f92672">.</span>co_code[i]

    <span style="color:#75715e"># Set fixed code back on co.</span>
    co<span style="color:#f92672">.</span>co_code <span style="color:#f92672">=</span> fixed_code
    co<span style="color:#f92672">.</span>freeze()

(version, timestamp, magic_int, co2, pypy, source_size) <span style="color:#f92672">=</span> load_module(<span style="color:#e6db74">&#39;my_test_script.pyc&#39;</span>)
opc <span style="color:#f92672">=</span> xdis<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>get_opcode(version, pypy)
nop_jump_junk(co2, opc)
inst_gen <span style="color:#f92672">=</span> get_instructions_bytes(co2<span style="color:#f92672">.</span>co_code, opc)

<span style="color:#66d9ef">for</span> inst <span style="color:#f92672">in</span> inst_gen:
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{}: {} {}&#39;</span><span style="color:#f92672">.</span>format(inst<span style="color:#f92672">.</span>offset, inst<span style="color:#f92672">.</span>opname, inst<span style="color:#f92672">.</span>argval))
</code></pre></div><p>Now we can fully disassemble our bytecode without any crashes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ae81ff">326</span>: DELETE_NAME <span style="color:#ae81ff">21</span>
<span style="color:#ae81ff">329</span>: LOAD_CONST None
<span style="color:#ae81ff">332</span>: RETURN_VALUE None
<span style="color:#ae81ff">336</span>: JUMP_FORWARD <span style="color:#ae81ff">1646</span>
<span style="color:#ae81ff">339</span>: NOP None
<span style="color:#ae81ff">340</span>: NOP None
<span style="color:#ae81ff">341</span>: NOP None
<span style="color:#ae81ff">342</span>: NOP None
<span style="color:#f92672">...</span>
<span style="color:#ae81ff">1646</span>: NOP None
</code></pre></div><p>With this clean disassembly, we can now find that the second anti-disassembly jump actually goes to a single NOP at the end of the <code>co_code</code>, so we could just delete the second jump and everything after it if we desired.</p>
<p>Unfortunately, however, we still cannot decompile it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> uncompyle6
uncompyle6<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>decompile(version, co2, sys<span style="color:#f92672">.</span>stdout)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Parse error at or near <span style="color:#e6db74">`</span>None<span style="color:#960050;background-color:#1e0010">&#39;</span> instruction at offset -1
</code></pre></div><p>For reasons I don&rsquo;t fully understand, this seems to be caused by <code>uncompyle6</code> breaking on <code>NOP</code> instructions. In fact, <a href="https://gist.github.com/Andoryuuta/5f4dff70a21d55f4b0960dad7613f5fd">just appending a single <code>NOP</code> to the end of your bytecode will break <code>uncompyle6</code></a>.</p>
<hr>
<p>As such, we will do something slightly more complex to fully remove the <code>NOP</code> instructions from the bytecode:</p>
<ol>
<li>Patch the anti-disassembly jump instruction and junk data with <code>NOP</code>s, (entirely deleting the second one).</li>
<li>Use <code>xdis</code> to disassemble each instruction.</li>
<li>Copy over each instruction that isn&rsquo;t a <code>NOP</code>, while fixing any instruction with an absolute offset.</li>
<li>Reassemble the instructions using <a href="https://github.com/rocky/python-xasm/"><code>xasm</code></a>.</li>
</ol>
<p>(Warning: the following code to update the absolute instruction offsets would break if a <code>NOP</code> instruction got deleted between a relative instruction and it&rsquo;s target offset. Something more advanced, like <a href="https://github.com/fireeye/flare-bytecode_graph"><code>flare-bytecode_graph</code></a>, would be required to handle that, although you would need to update it to Python3 and <code>xdis</code>/<code>xasm</code>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> xdis.load <span style="color:#f92672">import</span> load_module
<span style="color:#f92672">from</span> xdis.bytecode <span style="color:#f92672">import</span> get_instructions_bytes, instruction_size
<span style="color:#f92672">from</span> xasm.assemble <span style="color:#f92672">import</span> Assembler, Instruction, create_code
<span style="color:#f92672">import</span> xdis<span style="color:#f92672">,</span> xdis.main
<span style="color:#f92672">import</span> uncompyle6
<span style="color:#f92672">import</span> sys

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">nop_jump_junk</span>(co, opc):
    <span style="color:#75715e"># Get the first jump target.</span>
    first_jump_inst <span style="color:#f92672">=</span> next(get_instructions_bytes(co<span style="color:#f92672">.</span>co_code, opc))
    first_jump_target <span style="color:#f92672">=</span> first_jump_inst<span style="color:#f92672">.</span>argval

    <span style="color:#75715e"># Abuse the text header to find the second jump.</span>
    header_start_target <span style="color:#f92672">=</span> co<span style="color:#f92672">.</span>co_code<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">========&#39;</span>)
    has_pyprotect_header <span style="color:#f92672">=</span> header_start_target <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

    <span style="color:#75715e"># Get the start of the JUMP_FORWARD, right before the header.</span>
    jump_forward_inst_size <span style="color:#f92672">=</span> instruction_size(opc<span style="color:#f92672">.</span>opmap[<span style="color:#e6db74">&#39;JUMP_FORWARD&#39;</span>], opc)
    second_jump_start <span style="color:#f92672">=</span> header_start_target<span style="color:#f92672">-</span>jump_forward_inst_size

    <span style="color:#75715e"># Go over the existing code and decide whether to copy each byte.</span>
    fixed_code <span style="color:#f92672">=</span> bytearray()
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(co<span style="color:#f92672">.</span>co_code)):
        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> first_jump_target):
            <span style="color:#75715e"># Replace the first anti-disassembly jump with NOPs</span>
            fixed_code<span style="color:#f92672">.</span>append(opc<span style="color:#f92672">.</span>opmap[<span style="color:#e6db74">&#39;NOP&#39;</span>])
        <span style="color:#66d9ef">elif</span> has_pyprotect_header <span style="color:#f92672">and</span> (i <span style="color:#f92672">&gt;=</span> second_jump_start):
            <span style="color:#75715e"># Don&#39;t copy the second AD jump or anything after it.</span>
            <span style="color:#66d9ef">pass</span>
        <span style="color:#66d9ef">else</span>:
            <span style="color:#75715e"># Copy everything else.</span>
            fixed_code<span style="color:#f92672">.</span>append(co<span style="color:#f92672">.</span>co_code[i])

    <span style="color:#75715e"># Set fixed code back on co.</span>
    co<span style="color:#f92672">.</span>co_code <span style="color:#f92672">=</span> fixed_code
    co<span style="color:#f92672">.</span>freeze()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_nops</span>(co, opc, version):
    asm <span style="color:#f92672">=</span> Assembler(str(version))
    asm<span style="color:#f92672">.</span>code <span style="color:#f92672">=</span> co
    asm<span style="color:#f92672">.</span>code<span style="color:#f92672">.</span>instructions <span style="color:#f92672">=</span> []

    <span style="color:#75715e"># Disassemble the original instructions,</span>
    <span style="color:#75715e"># ignore if NOP, recalculate if absolute jump</span>
    <span style="color:#75715e"># then append them to our assembler.</span>
    removed_nop_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    cur_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> inst <span style="color:#f92672">in</span> get_instructions_bytes(asm<span style="color:#f92672">.</span>code, opc):
        <span style="color:#66d9ef">if</span> inst<span style="color:#f92672">.</span>opname <span style="color:#f92672">is</span> <span style="color:#e6db74">&#39;NOP&#39;</span>:
            removed_nop_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">continue</span>

        <span style="color:#75715e"># Recalculate absolute jump arg.</span>
        arg <span style="color:#f92672">=</span> inst<span style="color:#f92672">.</span>arg
        <span style="color:#66d9ef">if</span> inst<span style="color:#f92672">.</span>optype <span style="color:#f92672">is</span> <span style="color:#e6db74">&#39;jabs&#39;</span>:
            joff <span style="color:#f92672">=</span> inst<span style="color:#f92672">.</span>arg <span style="color:#f92672">-</span> inst<span style="color:#f92672">.</span>offset
            arg <span style="color:#f92672">=</span> cur_offset <span style="color:#f92672">+</span> joff

        <span style="color:#75715e"># Create a new `xasm` Instruction.</span>
        new_inst <span style="color:#f92672">=</span> Instruction()
        new_inst<span style="color:#f92672">.</span>opcode <span style="color:#f92672">=</span> inst<span style="color:#f92672">.</span>opcode
        new_inst<span style="color:#f92672">.</span>arg <span style="color:#f92672">=</span> arg
        new_inst<span style="color:#f92672">.</span>offset <span style="color:#f92672">=</span> cur_offset
        new_inst<span style="color:#f92672">.</span>line_no <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        
        <span style="color:#75715e"># Add the instruction to the assembler.</span>
        asm<span style="color:#f92672">.</span>code<span style="color:#f92672">.</span>instructions<span style="color:#f92672">.</span>append(new_inst)
        cur_offset <span style="color:#f92672">+=</span> inst<span style="color:#f92672">.</span>inst_size

    code <span style="color:#f92672">=</span> create_code(asm, [], [])

    <span style="color:#75715e"># HACK/FIX: xasm&#39;s `create_code` makes co_code a str on opcode version &lt; 3,</span>
    <span style="color:#75715e"># when it should _probably_ be checking the interpreter version instead.</span>
    <span style="color:#75715e"># uncompyle6 requires this to be bytes-like, so we convert it.</span>
    <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>version_info <span style="color:#f92672">&gt;</span> (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>):
        code<span style="color:#f92672">.</span>co_code <span style="color:#f92672">=</span> bytes([ord(c) <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> code<span style="color:#f92672">.</span>co_code])

    <span style="color:#66d9ef">return</span> code

(version, timestamp, magic_int, co2, pypy, source_size) <span style="color:#f92672">=</span> load_module(<span style="color:#e6db74">&#39;my_test_script.pyc&#39;</span>)
opc <span style="color:#f92672">=</span> xdis<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>get_opcode(version, pypy)
nop_jump_junk(co2, opc)
co2 <span style="color:#f92672">=</span> remove_nops(co2, opc, version)

uncompyle6<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>decompile(version, co2, sys<span style="color:#f92672">.</span>stdout)
</code></pre></div><p>Which now gives us this wildly invalid output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># uncompyle6 version 3.5.0</span>
<span style="color:#75715e"># Python bytecode 2.7</span>
<span style="color:#75715e"># Decompiled from: Python 3.7.1 (v3.7.1:260ec2c36a, Oct 20 2018, 14:57:15) [MSC v.1915 64 bit (AMD64)]</span>
<span style="color:#75715e"># Embedded file name: pyprotect.angelic47.com</span>
<span style="color:#66d9ef">try</span>:
    <span style="color:#f92672">import</span> sys<span style="color:#f92672">,</span> zlib<span style="color:#f92672">,</span> base64<span style="color:#f92672">,</span> marshal
    <span style="color:#66d9ef">raise</span> <span style="color:#66d9ef">lambda</span> <span style="color:#f92672">from</span> <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>_getframe()<span style="color:#f92672">.</span>f_code
    <span style="color:#66d9ef">try</span> <span style="color:#66d9ef">break</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">raise</span> <span style="color:#66d9ef">lambda</span> from<span style="color:#f92672">.</span>co_code
    <span style="color:#66d9ef">global</span> <span style="color:#f92672">&amp;&amp;</span> isdecoded <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">=</span> len(<span style="color:#66d9ef">try</span> <span style="color:#66d9ef">break</span>)
    <span style="color:#f92672">in</span> <span style="color:#f92672">in</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">cy</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">|</span><span style="color:#ae81ff">\xef\xbb\xee</span><span style="color:#e6db74">Y2</span><span style="color:#ae81ff">\xe3\xd8\x8e\xcd</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\xaf\xa9</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\xca\xa4</span><span style="color:#e6db74">d+</span><span style="color:#ae81ff">\xc4\x1b\x9c\xed\xbb\xa7</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\xdb\xd6\x8b</span><span style="color:#e6db74">!</span><span style="color:#ae81ff">\xbd\xf6</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\x9d\&#39;\xef\xfd</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\x8b\x11</span><span style="color:#e6db74">Y</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">.N</span><span style="color:#ae81ff">\x1c</span><span style="color:#e6db74">476ua=S9ht3</span><span style="color:#ae81ff">\x14</span><span style="color:#e6db74">9F&gt;mO[Xc</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">9J44I</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">DVX7c/a8&gt;bk</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">Hw.3J9fY</span><span style="color:#ae81ff">\x1c</span><span style="color:#e6db74">vC</span><span style="color:#ae81ff">\x18</span><span style="color:#e6db74">LA</span><span style="color:#ae81ff">\xfa</span><span style="color:#e6db74">QR,&lt;q/t7N5V&amp;43+d7?Br</span><span style="color:#ae81ff">\x15</span><span style="color:#e6db74">0Q</span><span style="color:#ae81ff">\xe9</span><span style="color:#e6db74">@+=SFUCO9Op/[+R^b</span><span style="color:#ae81ff">\xb7</span><span style="color:#e6db74">s7m;q4S+6u+</span><span style="color:#ae81ff">\x15\x06</span><span style="color:#e6db74">9</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">%b</span><span style="color:#ae81ff">\x06</span><span style="color:#e6db74">77</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">#f</span><span style="color:#ae81ff">\xe6</span><span style="color:#e6db74">;zodGr/{v6w1</span><span style="color:#ae81ff">\x03</span><span style="color:#e6db74">it</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">(u</span><span style="color:#ae81ff">\x14</span><span style="color:#e6db74">St</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">nQa</span><span style="color:#ae81ff">\xea</span><span style="color:#e6db74">Db</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">C64Je</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">^jT|ySV</span><span style="color:#ae81ff">\xf2</span><span style="color:#e6db74">Gl+</span><span style="color:#ae81ff">\xfa</span><span style="color:#e6db74">LeZ</span><span style="color:#ae81ff">\x1d</span><span style="color:#e6db74">fh</span><span style="color:#ae81ff">\x15\xef</span><span style="color:#e6db74">nc</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">zh</span><span style="color:#ae81ff">\x07</span><span style="color:#e6db74">fZ</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">FC!IrNEp</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">lz4AR</span><span style="color:#ae81ff">\xea</span><span style="color:#e6db74">2Y</span><span style="color:#ae81ff">\xc1</span><span style="color:#e6db74">So</span><span style="color:#ae81ff">\xc5</span><span style="color:#e6db74">m+</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">ei</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">fc</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">U1c&gt;5{H&amp;Oh</span><span style="color:#ae81ff">\xcd</span><span style="color:#e6db74">Gv</span><span style="color:#ae81ff">\x13</span><span style="color:#e6db74">1NM</span><span style="color:#ae81ff">\x00\x02</span><span style="color:#e6db74">eK</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">gc</span><span style="color:#ae81ff">\x10</span><span style="color:#e6db74">FRbMM</span><span style="color:#ae81ff">\x0f</span><span style="color:#e6db74">JF0^Q&#34;OFkPX</span><span style="color:#ae81ff">\x1e</span><span style="color:#e6db74">7|PuCVT`7q</span><span style="color:#ae81ff">\x0b\x1a</span><span style="color:#e6db74">GVh</span><span style="color:#ae81ff">\x13</span><span style="color:#e6db74">er9C51&#34;G</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">nr</span><span style="color:#ae81ff">\x1a\xd0</span><span style="color:#e6db74">L6 OWoe:&gt;uq</span><span style="color:#ae81ff">\x08</span><span style="color:#e6db74">mR[</span><span style="color:#ae81ff">\x7f\x0e</span><span style="color:#e6db74">sJ|P</span><span style="color:#ae81ff">\x16\\\x04</span><span style="color:#e6db74">oKIR</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">XZ~</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">kJQndoY|rkXGy</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">zx</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">ZVNR</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">Nyhl</span><span style="color:#ae81ff">\x0f</span><span style="color:#e6db74">V_k{</span><span style="color:#ae81ff">\x08\x0c\t</span><span style="color:#e6db74">N</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">IE|NJ</span><span style="color:#ae81ff">\x0f\\</span><span style="color:#e6db74">Gm</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">mGqu|RnH</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">[|</span><span style="color:#ae81ff">\x0f\x05</span><span style="color:#e6db74">T</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">EnF</span><span style="color:#ae81ff">\xd2\xe4\xa0\xad\xf4\xca\x85\xba\x1d</span><span style="color:#e6db74">Ni&gt;9?)</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\x84\x97\xf4\x98</span><span style="color:#e6db74">bZW64$</span><span style="color:#ae81ff">\n\x07</span><span style="color:#e6db74">_,</span><span style="color:#ae81ff">\t\x1c</span><span style="color:#e6db74">c</span><span style="color:#ae81ff">\x13\x87\xa2\xa5\xbc</span><span style="color:#e6db74">dJD2</span><span style="color:#ae81ff">\x17</span><span style="color:#e6db74">*</span><span style="color:#ae81ff">\xf6\xbc\xff\x9f\xd4\xea\x86\xe4\xa1\x82</span><span style="color:#e6db74">Tx</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">8B;FW[@</span><span style="color:#ae81ff">\x06\x16</span><span style="color:#e6db74">8</span><span style="color:#ae81ff">\x1f</span><span style="color:#e6db74">*&lt;]70CQ</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">3</span><span style="color:#ae81ff">\x14\t</span><span style="color:#e6db74">&amp;LCsc)</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">[BePkwV{MzL</span><span style="color:#ae81ff">\x0f</span><span style="color:#e6db74">GxvRQ</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">HHIVxR</span><span style="color:#ae81ff">\x0c\x0f</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\x04</span><span style="color:#e6db74">vm</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">Oe</span><span style="color:#ae81ff">\x04</span><span style="color:#e6db74">ix</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">X</span><span style="color:#ae81ff">\x16</span><span style="color:#e6db74">N[~</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">pW</span><span style="color:#ae81ff">\x08</span><span style="color:#e6db74">KLdwyUQ</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">DQ</span><span style="color:#ae81ff">\x08</span><span style="color:#e6db74">_koM</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">qpZj</span><span style="color:#ae81ff">\x12</span><span style="color:#e6db74">eL</span><span style="color:#ae81ff">\x05\r</span><span style="color:#e6db74">i</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">I</span><span style="color:#ae81ff">\x0b\t</span><span style="color:#e6db74">g</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">pRRQUQqeX</span><span style="color:#ae81ff">\x04</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">T</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">R={&gt;n</span><span style="color:#ae81ff">\xb9\xf8</span><span style="color:#e6db74">`(]</span><span style="color:#ae81ff">\x0c\xad\xbc\xa5\xf1\xd1\x07</span><span style="color:#e6db74">v</span><span style="color:#ae81ff">\x92\x10\x18\x8d\x10\xc6\x91</span><span style="color:#e6db74">0v</span><span style="color:#ae81ff">\xc5</span><span style="color:#e6db74">B</span><span style="color:#ae81ff">\xda\xe2\xb7\x18\x98\xf4\xce\xc5</span><span style="color:#e6db74">=</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">n,</span><span style="color:#ae81ff">\x11\xa0\xcf\x96\x99</span><span style="color:#e6db74">i;</span><span style="color:#ae81ff">\x0e\xcc\xf7</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\x99\xa4\x99</span><span style="color:#e6db74">6</span><span style="color:#ae81ff">\xfe</span><span style="color:#e6db74">sp</span><span style="color:#ae81ff">\x81\x8c\x9c</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\xaf\xb7\xfd\xcc\x0f\xe2\xdc\x96\x19\x07\x13\xca\x8b\xdc</span><span style="color:#e6db74">&#34;w}E</span><span style="color:#ae81ff">\xeb</span><span style="color:#e6db74">s</span><span style="color:#ae81ff">\xf9\xbc</span><span style="color:#e6db74">8</span><span style="color:#ae81ff">\xa1\xb3</span><span style="color:#e6db74">=</span><span style="color:#ae81ff">\x07</span><span style="color:#e6db74">t</span><span style="color:#ae81ff">\xea\x03\xc2</span><span style="color:#e6db74">H</span><span style="color:#ae81ff">\xa8\x82\xaa\xcd\xd9\x7f\xb2</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\xb2\xb3</span><span style="color:#e6db74">_J</span><span style="color:#ae81ff">\x97</span><span style="color:#e6db74">5xz:</span><span style="color:#ae81ff">\x01\xe5\xef\xa9\n</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\x81\xa9\xf2\x84\xd8</span><span style="color:#e6db74">~#1</span><span style="color:#ae81ff">\x8b\x9a</span><span style="color:#e6db74">[r</span><span style="color:#ae81ff">\xa3\xa2\xdd</span><span style="color:#e6db74">O</span><span style="color:#ae81ff">\xe2</span><span style="color:#e6db74">~f</span><span style="color:#ae81ff">\x93</span><span style="color:#e6db74">w</span><span style="color:#ae81ff">\xb1</span><span style="color:#e6db74">R</span><span style="color:#ae81ff">\xe0</span><span style="color:#e6db74">L</span><span style="color:#ae81ff">\xd3</span><span style="color:#e6db74">e4</span><span style="color:#ae81ff">\xf0\x01\xdc</span><span style="color:#e6db74">?</span><span style="color:#ae81ff">\xb5</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\x9c\xde</span><span style="color:#e6db74">]$p</span><span style="color:#ae81ff">\xf7</span><span style="color:#e6db74">9Z</span><span style="color:#ae81ff">\x92\xc0</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\x16\x8b</span><span style="color:#e6db74">?</span><span style="color:#ae81ff">\xda</span><span style="color:#e6db74">Sr</span><span style="color:#ae81ff">\x90\xb2</span><span style="color:#e6db74">0</span><span style="color:#ae81ff">\x96\xaa\x95\x8d\x06\xf4</span><span style="color:#e6db74">I</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">|</span><span style="color:#ae81ff">\x8d\xeb\x84</span><span style="color:#e6db74">u5</span><span style="color:#ae81ff">\xa1</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\xa5</span><span style="color:#e6db74">O{</span><span style="color:#ae81ff">\xc7\xcd\xae\xf7\x9c\xc7</span><span style="color:#e6db74">W!9</span><span style="color:#ae81ff">\xf7\x9b\x10\x16\xa7\xe9\xdc\xb5\xda</span><span style="color:#e6db74">E</span><span style="color:#ae81ff">\xde\x05</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\xa1\xfe</span><span style="color:#e6db74">*</span><span style="color:#ae81ff">\xba\x94\x93</span><span style="color:#e6db74">&amp;D</span><span style="color:#ae81ff">\x84\xe6</span><span style="color:#e6db74">f</span><span style="color:#ae81ff">\xd8</span><span style="color:#e6db74">Pa</span><span style="color:#ae81ff">\xb3</span><span style="color:#e6db74">U</span><span style="color:#ae81ff">\xeb\x89\xe7\xbd\x90\xc8</span><span style="color:#e6db74">+</span><span style="color:#ae81ff">\xb8\xd7\x85\xed\xd5\&#39;</span><span style="color:#e6db74">h</span><span style="color:#ae81ff">\x82\xbf</span><span style="color:#e6db74">z!</span><span style="color:#ae81ff">\xe7\x04</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\x12</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\x1b\xc8</span><span style="color:#e6db74">O</span><span style="color:#ae81ff">\xe3\xa6\x99\xe4\xfb\x94\x7f\xe1\x96</span><span style="color:#e6db74">F%.8</span><span style="color:#ae81ff">\xb0</span><span style="color:#e6db74">-l-^&amp;(1+</span><span style="color:#ae81ff">\xb1\x9f</span><span style="color:#e6db74">^r</span><span style="color:#ae81ff">\xd5\x82</span><span style="color:#e6db74">,</span><span style="color:#ae81ff">\x97\xdc\xb4\xfe\x1c\x89</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\xaf\x1b\x17\x08</span><span style="color:#e6db74">v</span><span style="color:#ae81ff">\x08</span><span style="color:#e6db74">0</span><span style="color:#ae81ff">\x92\xfd\xe7\xc7</span><span style="color:#e6db74">j</span><span style="color:#ae81ff">\xf6</span><span style="color:#e6db74">Urg</span><span style="color:#ae81ff">\xe4\xb4\x8f\xf4</span><span style="color:#e6db74">C!</span><span style="color:#ae81ff">\xf3\xf3</span><span style="color:#e6db74">6F</span><span style="color:#ae81ff">\xc5</span><span style="color:#e6db74">&lt;_Y</span><span style="color:#ae81ff">\xb3\xbe\x12</span><span style="color:#e6db74">a</span><span style="color:#ae81ff">\x9b\x9b\xe9\x9c\x8c\x97\x93</span><span style="color:#e6db74">#</span><span style="color:#ae81ff">\xd0\xec\x87\x7f\xd1\xea</span><span style="color:#e6db74">(</span><span style="color:#ae81ff">\x94\x98\xa4\xc0\x1b\x04\xd0</span><span style="color:#e6db74">,</span><span style="color:#ae81ff">\xba</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\x0e\xfb</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\xc0</span><span style="color:#e6db74">5P</span><span style="color:#ae81ff">\x17\xbe</span><span style="color:#e6db74">(6&#34;</span><span style="color:#ae81ff">\xf7\xdd\xb2\xa5</span><span style="color:#e6db74">o</span><span style="color:#ae81ff">\x9f\xdc\xa0</span><span style="color:#e6db74">-@B</span><span style="color:#ae81ff">\x87\x9c</span><span style="color:#e6db74">L</span><span style="color:#ae81ff">\xf9\xfa\x8f\xcb\xf5</span><span style="color:#e6db74">)</span><span style="color:#ae81ff">\xd0</span><span style="color:#e6db74">H</span><span style="color:#ae81ff">\x84</span><span style="color:#e6db74">_vB</span><span style="color:#ae81ff">\xef\x1b</span><span style="color:#e6db74">e</span><span style="color:#ae81ff">\xb7</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\xc4\xa4\x7f</span><span style="color:#e6db74">K</span><span style="color:#ae81ff">\xd5\xe4\xea\x86\x18\xec\xcf</span><span style="color:#e6db74">!M</span><span style="color:#ae81ff">\x04</span><span style="color:#e6db74">r</span><span style="color:#ae81ff">\x96</span><span style="color:#e6db74">O</span><span style="color:#ae81ff">\xe1\x17\xb5\xf0\x19</span><span style="color:#e6db74">2</span><span style="color:#ae81ff">\xa5</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\xfe\x01\xca\xa4\xa8\xc4</span><span style="color:#e6db74">I</span><span style="color:#ae81ff">\x17</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\xa7\x9c</span><span style="color:#e6db74">W:</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">aoM</span><span style="color:#ae81ff">\x16\xbe\xb1\x8a\xec\xbe\xe7\x85\xbf</span><span style="color:#e6db74">K3u</span><span style="color:#ae81ff">\xa8\x80\xe5\xa2\x19\x17\t\x17\xa1\xf1</span><span style="color:#e6db74">A</span><span style="color:#ae81ff">\xd5</span><span style="color:#e6db74">j</span><span style="color:#ae81ff">\x18</span><span style="color:#e6db74">w{</span><span style="color:#ae81ff">\xee\x8f\xb4</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\xdd</span><span style="color:#e6db74">0}</span><span style="color:#ae81ff">\xb9</span><span style="color:#e6db74">2</span><span style="color:#ae81ff">\x9e\x8f\x87</span><span style="color:#e6db74">^</span><span style="color:#ae81ff">\xdc\xf6\xa4</span><span style="color:#e6db74">&gt;</span><span style="color:#ae81ff">\xf6\xfe\r\x0e\x9c\xc8</span><span style="color:#e6db74">j6</span><span style="color:#ae81ff">\xee\xdc\xe4</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\xd0</span><span style="color:#e6db74">dTo</span><span style="color:#ae81ff">\xc0\x87</span><span style="color:#e6db74">j</span><span style="color:#ae81ff">\xe1\x0c</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\xad\xc4</span><span style="color:#e6db74">B:</span><span style="color:#ae81ff">\xa1\xaf\xc7\xcc</span><span style="color:#e6db74">9</span><span style="color:#ae81ff">\xac</span><span style="color:#e6db74">0$p</span><span style="color:#ae81ff">\xed</span><span style="color:#e6db74">!</span><span style="color:#ae81ff">\xb7\xd2\xea\xdc\x86\xee</span><span style="color:#e6db74">s</span><span style="color:#ae81ff">\x92\xf8\xbc\x89</span><span style="color:#e6db74">H:</span><span style="color:#ae81ff">\x17\xae</span><span style="color:#e6db74">Ycgq</span><span style="color:#ae81ff">\x9c\xf5</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\xa8\t\xee</span><span style="color:#e6db74">~/5</span><span style="color:#ae81ff">\xf9</span><span style="color:#e6db74">@8q</span><span style="color:#ae81ff">\x97</span><span style="color:#e6db74">]</span><span style="color:#ae81ff">\x8d</span><span style="color:#e6db74">OM</span><span style="color:#ae81ff">\xcc\xc3\x14\x10</span><span style="color:#e6db74">8h</span><span style="color:#ae81ff">\xab</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\xec\xaa</span><span style="color:#e6db74">2</span><span style="color:#ae81ff">\xfc\t</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\x1e\xe8\x97</span><span style="color:#e6db74">;</span><span style="color:#ae81ff">\x15</span><span style="color:#e6db74">`</span><span style="color:#ae81ff">\xa1</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\x13\x7f\xfd\xe1\xd6\xb2\x0b\x13</span><span style="color:#e6db74">r</span><span style="color:#ae81ff">\xdd\xe6\xa3</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\xa7\t</span><span style="color:#e6db74">U</span><span style="color:#ae81ff">\xd0\x95\xcc\xb1\xef</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\x97\xc2\xed\xd1\x1e</span><span style="color:#e6db74">Vw</span><span style="color:#ae81ff">\t\xe4\xcb\xe6\xc9\x84</span><span style="color:#e6db74">B</span><span style="color:#ae81ff">\x8b\x7f</span><span style="color:#e6db74">w</span><span style="color:#ae81ff">\xa4\xbb</span><span style="color:#e6db74">8;</span><span style="color:#ae81ff">\xd9\xa1</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\x91</span><span style="color:#e6db74">Z</span><span style="color:#ae81ff">\x0b\x18\x08\xeb</span><span style="color:#e6db74">dgY</span><span style="color:#ae81ff">\xed</span><span style="color:#e6db74">8OY7</span><span style="color:#ae81ff">\xb4\x98\x0c</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\x9b</span><span style="color:#e6db74">+V</span><span style="color:#ae81ff">\x80</span><span style="color:#e6db74">6</span><span style="color:#ae81ff">\xa7\x91\xc8\x7f</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\xe5\xeb\x7f\xab\xe3\x1f\xed\xff\x8b\x7f\x1a</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\xf1\xd9\xd3\x03</span><span style="color:#e6db74">k</span><span style="color:#ae81ff">\x85</span><span style="color:#e6db74">e</span><span style="color:#ae81ff">\xa5\xe3</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\x05\x0f\xbf</span><span style="color:#e6db74">z=</span><span style="color:#ae81ff">\xa0\x0b\xc5\xec\x94</span><span style="color:#e6db74">X</span><span style="color:#ae81ff">\xd3\x1a\x1b\x19\x82\xbe</span><span style="color:#e6db74">3*</span><span style="color:#ae81ff">\xc7\x04\xd3\xda\xb8\xe0\xde\x88\xff\x83\xa0</span><span style="color:#e6db74">eh</span><span style="color:#ae81ff">\x10\xa2\xe9</span><span style="color:#e6db74">D</span><span style="color:#ae81ff">\x97\x1d</span><span style="color:#e6db74">u</span><span style="color:#ae81ff">\xb8\xda</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\x03\x08</span><span style="color:#e6db74">3</span><span style="color:#ae81ff">\xc8\x80</span><span style="color:#e6db74">nS</span><span style="color:#ae81ff">\xcc</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\x8b</span><span style="color:#e6db74">6z</span><span style="color:#ae81ff">\xef\xe7</span><span style="color:#e6db74">&gt;q</span><span style="color:#ae81ff">\x0e\xf9</span><span style="color:#e6db74">_</span><span style="color:#ae81ff">\x14</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\xcb\x9b\x14\xab\t\xc8\xd8</span><span style="color:#e6db74">e </span><span style="color:#ae81ff">\xad</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\xa2\x84</span><span style="color:#e6db74">f</span><span style="color:#ae81ff">\xf1\x08</span><span style="color:#e6db74">R</span><span style="color:#ae81ff">\x88\x9f\x97</span><span style="color:#e6db74">60J</span><span style="color:#ae81ff">\\\x07\xb3\x01</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\x01\x94</span><span style="color:#e6db74">U</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">Us4</span><span style="color:#ae81ff">\x1b\x08\xe8\x7f\x07\xec</span><span style="color:#e6db74">r$</span><span style="color:#ae81ff">\xd0</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\x8c\xb5\xe8\x03\xa8\x95\xa8</span><span style="color:#e6db74">~</span><span style="color:#ae81ff">\x1a\xff</span><span style="color:#e6db74">#|</span><span style="color:#ae81ff">\xa6\r</span><span style="color:#e6db74">Qg</span><span style="color:#ae81ff">\xee\xe7\x90\x08\xda</span><span style="color:#e6db74">,oD</span><span style="color:#ae81ff">\x91\x88</span><span style="color:#e6db74">wr</span><span style="color:#ae81ff">\xf5\x1a\xa1\xa3\xb2\xa0\xa4\xf6</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\x9d\xa0</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\x95\x80\x86\x8b\xef\x98\x8e\xb0\xc0\xde</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\xf6\x0f\xa1\xc9\x8b\n\x10\x8d\x8b\xcb</span><span style="color:#e6db74">!</span><span style="color:#ae81ff">\x9e\xf2\x05\x94</span><span style="color:#e6db74">`U</span><span style="color:#ae81ff">\xe4\xe6\xc8\x88</span><span style="color:#e6db74">Kk</span><span style="color:#ae81ff">\xeb\x1f\x98</span><span style="color:#e6db74">,|]</span><span style="color:#ae81ff">\x9c\xa2\x9d\xcc\x15\x93\xae\x08\x06\x88</span><span style="color:#e6db74">t</span><span style="color:#ae81ff">\x8e</span><span style="color:#e6db74">z^3</span><span style="color:#ae81ff">\xaf\xd0\xf5</span><span style="color:#e6db74">0</span><span style="color:#ae81ff">\x11</span><span style="color:#e6db74">i</span><span style="color:#ae81ff">\xa2</span><span style="color:#e6db74">=</span><span style="color:#ae81ff">\xca\xb4</span><span style="color:#e6db74">/</span><span style="color:#ae81ff">\xa4\x1b</span><span style="color:#e6db74">2.AyM</span><span style="color:#ae81ff">\xc3</span><span style="color:#e6db74">Q</span><span style="color:#ae81ff">\&#39;\xbd</span><span style="color:#e6db74">k</span><span style="color:#ae81ff">\xfb\xec\x9a</span><span style="color:#e6db74">q</span><span style="color:#ae81ff">\xb8</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\x80</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">\xd3\xf9\xb8\x0b\x84</span><span style="color:#e6db74">1</span><span style="color:#ae81ff">\xf1\x15\xa0</span><span style="color:#e6db74">I</span><span style="color:#ae81ff">\xbb</span><span style="color:#e6db74">G</span><span style="color:#ae81ff">\x82</span><span style="color:#e6db74">4</span><span style="color:#ae81ff">\xe6</span><span style="color:#e6db74">;p</span><span style="color:#ae81ff">\xd1\xa5</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\xc8\xb8</span><span style="color:#e6db74">O</span><span style="color:#ae81ff">\xa3</span><span style="color:#e6db74">TK</span><span style="color:#ae81ff">\x88\xec\xca\xb3</span><span style="color:#e6db74">(</span><span style="color:#ae81ff">\x7f\x16</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\xd5\xa6\x08</span><span style="color:#e6db74">kQ</span><span style="color:#ae81ff">\xb6\xce\xe2\t\xa0\x17\xd4</span><span style="color:#e6db74">(&#39;</span>
    <span style="color:#66d9ef">yield</span> <span style="color:#66d9ef">exec</span> <span style="color:#f92672">=</span> len(<span style="color:#f92672">in</span> <span style="color:#f92672">in</span> <span style="color:#f92672">&amp;&amp;</span>)
    <span style="color:#f92672">++</span> <span style="color:#f92672">+</span> dict <span style="color:#66d9ef">exec</span> <span style="color:#66d9ef">except</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">lambda</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">&amp;&amp;</span> isdecoded <span style="color:#f92672">from</span> in range(<span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">yield</span> <span style="color:#66d9ef">exec</span>):
        <span style="color:#f92672">++</span> <span style="color:#f92672">+</span> dict <span style="color:#66d9ef">exec</span> <span style="color:#66d9ef">except</span> <span style="color:#f92672">+=</span> chr(ord(<span style="color:#f92672">in</span> <span style="color:#f92672">in</span> <span style="color:#f92672">&amp;&amp;</span>[<span style="color:#66d9ef">lambda</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">&amp;&amp;</span> isdecoded from]) <span style="color:#f92672">^</span> ord(<span style="color:#66d9ef">try</span> <span style="color:#66d9ef">break</span>[(<span style="color:#66d9ef">lambda</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">&amp;&amp;</span> isdecoded <span style="color:#f92672">from</span> <span style="color:#f92672">%</span> <span style="color:#66d9ef">global</span> <span style="color:#f92672">&amp;&amp;</span> isdecoded <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>)]))

    <span style="color:#f92672">++</span> <span style="color:#f92672">+</span> dict <span style="color:#66d9ef">exec</span> <span style="color:#66d9ef">except</span> <span style="color:#f92672">=</span> marshal<span style="color:#f92672">.</span>loads(zlib<span style="color:#f92672">.</span>decompress(base64<span style="color:#f92672">.</span>b64decode(<span style="color:#f92672">++</span> <span style="color:#f92672">+</span> dict <span style="color:#66d9ef">exec</span> <span style="color:#66d9ef">except</span>)))
    <span style="color:#66d9ef">exec</span> <span style="color:#f92672">++</span> <span style="color:#f92672">+</span> dict <span style="color:#66d9ef">exec</span> <span style="color:#66d9ef">except</span>
    <span style="color:#66d9ef">exec</span> <span style="color:#f92672">from</span> or exec(<span style="color:#66d9ef">raise</span> <span style="color:#66d9ef">lambda</span> from)
    <span style="color:#66d9ef">del</span> <span style="color:#66d9ef">try</span> <span style="color:#66d9ef">break</span>
    <span style="color:#66d9ef">del</span> <span style="color:#66d9ef">global</span> <span style="color:#f92672">&amp;&amp;</span> isdecoded <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>
    <span style="color:#66d9ef">del</span> <span style="color:#f92672">in</span> <span style="color:#f92672">in</span> <span style="color:#f92672">&amp;&amp;</span>
    <span style="color:#66d9ef">del</span> <span style="color:#66d9ef">yield</span> <span style="color:#66d9ef">exec</span>
    <span style="color:#66d9ef">del</span> <span style="color:#f92672">++</span> <span style="color:#f92672">+</span> dict <span style="color:#66d9ef">exec</span> <span style="color:#66d9ef">except</span>
    <span style="color:#66d9ef">del</span> <span style="color:#66d9ef">lambda</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">&amp;&amp;</span> isdecoded <span style="color:#f92672">from</span>
    del raise lambda from
    <span style="color:#66d9ef">del</span> <span style="color:#f92672">from</span> or exec
<span style="color:#66d9ef">except</span>:
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;An uncorrectable error has occurred while loading module.&#39;</span>

<span style="color:#f92672">from</span> or exec <span style="color:#f92672">=</span> True
<span style="color:#66d9ef">del</span> <span style="color:#f92672">from</span> or exec
</code></pre></div><p>If we print the <code>co_names</code> value before decompiling, the problem becomes more apparent.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">print</span>(co2<span style="color:#f92672">.</span>co_names)
(<span style="color:#e6db74">&#39;sys&#39;</span>, <span style="color:#e6db74">&#39;zlib&#39;</span>, <span style="color:#e6db74">&#39;base64&#39;</span>, <span style="color:#e6db74">&#39;marshal&#39;</span>, <span style="color:#e6db74">&#39;_getframe&#39;</span>, <span style="color:#e6db74">&#39;f_code&#39;</span>, <span style="color:#e6db74">&#39;raise lambda from&#39;</span>, <span style="color:#e6db74">&#39;co_code&#39;</span>, <span style="color:#e6db74">&#39;try break&#39;</span>, <span style="color:#e6db74">&#39;len&#39;</span>, <span style="color:#e6db74">&#39;global &amp;&amp; isdecoded + 8&#39;</span>, <span style="color:#e6db74">&#39;in in &amp;&amp;&#39;</span>, <span style="color:#e6db74">&#39;yield exec&#39;</span>, <span style="color:#e6db74">&#39;++ + dict exec except&#39;</span>, <span style="color:#e6db74">&#39;range&#39;</span>, <span style="color:#e6db74">&#39;lambda if &amp;&amp; isdecoded from&#39;</span>, <span style="color:#e6db74">&#39;chr&#39;</span>, <span style="color:#e6db74">&#39;ord&#39;</span>, <span style="color:#e6db74">&#39;loads&#39;</span>, <span style="color:#e6db74">&#39;decompress&#39;</span>, <span style="color:#e6db74">&#39;b64decode&#39;</span>, <span style="color:#e6db74">&#39;from or exec&#39;</span>, <span style="color:#e6db74">&#39;True&#39;</span>)
</code></pre></div><p>Our local variable names have been replaced with gibberish python syntax (even with spaces!). We can clean this up by replacing any name that is a python keyword or contains a space.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> keyword
names <span style="color:#f92672">=</span> list(co2<span style="color:#f92672">.</span>co_names)
<span style="color:#66d9ef">for</span> i, name <span style="color:#f92672">in</span> enumerate(co2<span style="color:#f92672">.</span>co_names):
    <span style="color:#66d9ef">if</span> (name <span style="color:#f92672">in</span> keyword<span style="color:#f92672">.</span>kwlist) <span style="color:#f92672">or</span> (<span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">in</span> name):
        names[i] <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#39;var{}&#39;</span><span style="color:#f92672">.</span>format(i)

co2<span style="color:#f92672">.</span>co_names <span style="color:#f92672">=</span> tuple(names)
</code></pre></div><p>Which finally gives us a readable decompilation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># uncompyle6 version 3.5.0</span>
<span style="color:#75715e"># Python bytecode 2.7</span>
<span style="color:#75715e"># Decompiled from: Python 3.7.1 (v3.7.1:260ec2c36a, Oct 20 2018, 14:57:15) [MSC v.1915 64 bit (AMD64)]</span>
<span style="color:#75715e"># Embedded file name: pyprotect.angelic47.com</span>
<span style="color:#66d9ef">try</span>:
    <span style="color:#f92672">import</span> sys<span style="color:#f92672">,</span> zlib<span style="color:#f92672">,</span> base64<span style="color:#f92672">,</span> marshal
    var6 <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>_getframe()<span style="color:#f92672">.</span>f_code
    var8 <span style="color:#f92672">=</span> var6<span style="color:#f92672">.</span>co_code
    var10 <span style="color:#f92672">=</span> len(var8)
    var11 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">cy</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">|</span><span style="color:#ae81ff">\xef\xbb\xee</span><span style="color:#e6db74">Y2</span><span style="color:#ae81ff">\xe3\xd8\x8e\xcd</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\xaf\xa9</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\xca\xa4</span><span style="color:#e6db74">d+</span><span style="color:#ae81ff">\xc4\x1b\x9c\xed\xbb\xa7</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\xdb\xd6\x8b</span><span style="color:#e6db74">!</span><span style="color:#ae81ff">\xbd\xf6</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\x9d\&#39;\xef\xfd</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\x8b\x11</span><span style="color:#e6db74">Y</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">.N</span><span style="color:#ae81ff">\x1c</span><span style="color:#e6db74">476ua=S9ht3</span><span style="color:#ae81ff">\x14</span><span style="color:#e6db74">9F&gt;mO[Xc</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">9J44I</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">DVX7c/a8&gt;bk</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">Hw.3J9fY</span><span style="color:#ae81ff">\x1c</span><span style="color:#e6db74">vC</span><span style="color:#ae81ff">\x18</span><span style="color:#e6db74">LA</span><span style="color:#ae81ff">\xfa</span><span style="color:#e6db74">QR,&lt;q/t7N5V&amp;43+d7?Br</span><span style="color:#ae81ff">\x15</span><span style="color:#e6db74">0Q</span><span style="color:#ae81ff">\xe9</span><span style="color:#e6db74">@+=SFUCO9Op/[+R^b</span><span style="color:#ae81ff">\xb7</span><span style="color:#e6db74">s7m;q4S+6u+</span><span style="color:#ae81ff">\x15\x06</span><span style="color:#e6db74">9</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">%b</span><span style="color:#ae81ff">\x06</span><span style="color:#e6db74">77</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">#f</span><span style="color:#ae81ff">\xe6</span><span style="color:#e6db74">;zodGr/{v6w1</span><span style="color:#ae81ff">\x03</span><span style="color:#e6db74">it</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">(u</span><span style="color:#ae81ff">\x14</span><span style="color:#e6db74">St</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">nQa</span><span style="color:#ae81ff">\xea</span><span style="color:#e6db74">Db</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">C64Je</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">^jT|ySV</span><span style="color:#ae81ff">\xf2</span><span style="color:#e6db74">Gl+</span><span style="color:#ae81ff">\xfa</span><span style="color:#e6db74">LeZ</span><span style="color:#ae81ff">\x1d</span><span style="color:#e6db74">fh</span><span style="color:#ae81ff">\x15\xef</span><span style="color:#e6db74">nc</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">zh</span><span style="color:#ae81ff">\x07</span><span style="color:#e6db74">fZ</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">FC!IrNEp</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">lz4AR</span><span style="color:#ae81ff">\xea</span><span style="color:#e6db74">2Y</span><span style="color:#ae81ff">\xc1</span><span style="color:#e6db74">So</span><span style="color:#ae81ff">\xc5</span><span style="color:#e6db74">m+</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">ei</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">fc</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">U1c&gt;5{H&amp;Oh</span><span style="color:#ae81ff">\xcd</span><span style="color:#e6db74">Gv</span><span style="color:#ae81ff">\x13</span><span style="color:#e6db74">1NM</span><span style="color:#ae81ff">\x00\x02</span><span style="color:#e6db74">eK</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">gc</span><span style="color:#ae81ff">\x10</span><span style="color:#e6db74">FRbMM</span><span style="color:#ae81ff">\x0f</span><span style="color:#e6db74">JF0^Q&#34;OFkPX</span><span style="color:#ae81ff">\x1e</span><span style="color:#e6db74">7|PuCVT`7q</span><span style="color:#ae81ff">\x0b\x1a</span><span style="color:#e6db74">GVh</span><span style="color:#ae81ff">\x13</span><span style="color:#e6db74">er9C51&#34;G</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">nr</span><span style="color:#ae81ff">\x1a\xd0</span><span style="color:#e6db74">L6 OWoe:&gt;uq</span><span style="color:#ae81ff">\x08</span><span style="color:#e6db74">mR[</span><span style="color:#ae81ff">\x7f\x0e</span><span style="color:#e6db74">sJ|P</span><span style="color:#ae81ff">\x16\\\x04</span><span style="color:#e6db74">oKIR</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">XZ~</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">kJQndoY|rkXGy</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">zx</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">ZVNR</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">Nyhl</span><span style="color:#ae81ff">\x0f</span><span style="color:#e6db74">V_k{</span><span style="color:#ae81ff">\x08\x0c\t</span><span style="color:#e6db74">N</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">IE|NJ</span><span style="color:#ae81ff">\x0f\\</span><span style="color:#e6db74">Gm</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">mGqu|RnH</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">[|</span><span style="color:#ae81ff">\x0f\x05</span><span style="color:#e6db74">T</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">EnF</span><span style="color:#ae81ff">\xd2\xe4\xa0\xad\xf4\xca\x85\xba\x1d</span><span style="color:#e6db74">Ni&gt;9?)</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\x84\x97\xf4\x98</span><span style="color:#e6db74">bZW64$</span><span style="color:#ae81ff">\n\x07</span><span style="color:#e6db74">_,</span><span style="color:#ae81ff">\t\x1c</span><span style="color:#e6db74">c</span><span style="color:#ae81ff">\x13\x87\xa2\xa5\xbc</span><span style="color:#e6db74">dJD2</span><span style="color:#ae81ff">\x17</span><span style="color:#e6db74">*</span><span style="color:#ae81ff">\xf6\xbc\xff\x9f\xd4\xea\x86\xe4\xa1\x82</span><span style="color:#e6db74">Tx</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">8B;FW[@</span><span style="color:#ae81ff">\x06\x16</span><span style="color:#e6db74">8</span><span style="color:#ae81ff">\x1f</span><span style="color:#e6db74">*&lt;]70CQ</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">3</span><span style="color:#ae81ff">\x14\t</span><span style="color:#e6db74">&amp;LCsc)</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">[BePkwV{MzL</span><span style="color:#ae81ff">\x0f</span><span style="color:#e6db74">GxvRQ</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">HHIVxR</span><span style="color:#ae81ff">\x0c\x0f</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\x04</span><span style="color:#e6db74">vm</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">Oe</span><span style="color:#ae81ff">\x04</span><span style="color:#e6db74">ix</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">X</span><span style="color:#ae81ff">\x16</span><span style="color:#e6db74">N[~</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">pW</span><span style="color:#ae81ff">\x08</span><span style="color:#e6db74">KLdwyUQ</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">DQ</span><span style="color:#ae81ff">\x08</span><span style="color:#e6db74">_koM</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">qpZj</span><span style="color:#ae81ff">\x12</span><span style="color:#e6db74">eL</span><span style="color:#ae81ff">\x05\r</span><span style="color:#e6db74">i</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">I</span><span style="color:#ae81ff">\x0b\t</span><span style="color:#e6db74">g</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">pRRQUQqeX</span><span style="color:#ae81ff">\x04</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">T</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">R={&gt;n</span><span style="color:#ae81ff">\xb9\xf8</span><span style="color:#e6db74">`(]</span><span style="color:#ae81ff">\x0c\xad\xbc\xa5\xf1\xd1\x07</span><span style="color:#e6db74">v</span><span style="color:#ae81ff">\x92\x10\x18\x8d\x10\xc6\x91</span><span style="color:#e6db74">0v</span><span style="color:#ae81ff">\xc5</span><span style="color:#e6db74">B</span><span style="color:#ae81ff">\xda\xe2\xb7\x18\x98\xf4\xce\xc5</span><span style="color:#e6db74">=</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">n,</span><span style="color:#ae81ff">\x11\xa0\xcf\x96\x99</span><span style="color:#e6db74">i;</span><span style="color:#ae81ff">\x0e\xcc\xf7</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\x99\xa4\x99</span><span style="color:#e6db74">6</span><span style="color:#ae81ff">\xfe</span><span style="color:#e6db74">sp</span><span style="color:#ae81ff">\x81\x8c\x9c</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\xaf\xb7\xfd\xcc\x0f\xe2\xdc\x96\x19\x07\x13\xca\x8b\xdc</span><span style="color:#e6db74">&#34;w}E</span><span style="color:#ae81ff">\xeb</span><span style="color:#e6db74">s</span><span style="color:#ae81ff">\xf9\xbc</span><span style="color:#e6db74">8</span><span style="color:#ae81ff">\xa1\xb3</span><span style="color:#e6db74">=</span><span style="color:#ae81ff">\x07</span><span style="color:#e6db74">t</span><span style="color:#ae81ff">\xea\x03\xc2</span><span style="color:#e6db74">H</span><span style="color:#ae81ff">\xa8\x82\xaa\xcd\xd9\x7f\xb2</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\xb2\xb3</span><span style="color:#e6db74">_J</span><span style="color:#ae81ff">\x97</span><span style="color:#e6db74">5xz:</span><span style="color:#ae81ff">\x01\xe5\xef\xa9\n</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\x81\xa9\xf2\x84\xd8</span><span style="color:#e6db74">~#1</span><span style="color:#ae81ff">\x8b\x9a</span><span style="color:#e6db74">[r</span><span style="color:#ae81ff">\xa3\xa2\xdd</span><span style="color:#e6db74">O</span><span style="color:#ae81ff">\xe2</span><span style="color:#e6db74">~f</span><span style="color:#ae81ff">\x93</span><span style="color:#e6db74">w</span><span style="color:#ae81ff">\xb1</span><span style="color:#e6db74">R</span><span style="color:#ae81ff">\xe0</span><span style="color:#e6db74">L</span><span style="color:#ae81ff">\xd3</span><span style="color:#e6db74">e4</span><span style="color:#ae81ff">\xf0\x01\xdc</span><span style="color:#e6db74">?</span><span style="color:#ae81ff">\xb5</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\x9c\xde</span><span style="color:#e6db74">]$p</span><span style="color:#ae81ff">\xf7</span><span style="color:#e6db74">9Z</span><span style="color:#ae81ff">\x92\xc0</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\x16\x8b</span><span style="color:#e6db74">?</span><span style="color:#ae81ff">\xda</span><span style="color:#e6db74">Sr</span><span style="color:#ae81ff">\x90\xb2</span><span style="color:#e6db74">0</span><span style="color:#ae81ff">\x96\xaa\x95\x8d\x06\xf4</span><span style="color:#e6db74">I</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">|</span><span style="color:#ae81ff">\x8d\xeb\x84</span><span style="color:#e6db74">u5</span><span style="color:#ae81ff">\xa1</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\xa5</span><span style="color:#e6db74">O{</span><span style="color:#ae81ff">\xc7\xcd\xae\xf7\x9c\xc7</span><span style="color:#e6db74">W!9</span><span style="color:#ae81ff">\xf7\x9b\x10\x16\xa7\xe9\xdc\xb5\xda</span><span style="color:#e6db74">E</span><span style="color:#ae81ff">\xde\x05</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\xa1\xfe</span><span style="color:#e6db74">*</span><span style="color:#ae81ff">\xba\x94\x93</span><span style="color:#e6db74">&amp;D</span><span style="color:#ae81ff">\x84\xe6</span><span style="color:#e6db74">f</span><span style="color:#ae81ff">\xd8</span><span style="color:#e6db74">Pa</span><span style="color:#ae81ff">\xb3</span><span style="color:#e6db74">U</span><span style="color:#ae81ff">\xeb\x89\xe7\xbd\x90\xc8</span><span style="color:#e6db74">+</span><span style="color:#ae81ff">\xb8\xd7\x85\xed\xd5\&#39;</span><span style="color:#e6db74">h</span><span style="color:#ae81ff">\x82\xbf</span><span style="color:#e6db74">z!</span><span style="color:#ae81ff">\xe7\x04</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\x12</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\x1b\xc8</span><span style="color:#e6db74">O</span><span style="color:#ae81ff">\xe3\xa6\x99\xe4\xfb\x94\x7f\xe1\x96</span><span style="color:#e6db74">F%.8</span><span style="color:#ae81ff">\xb0</span><span style="color:#e6db74">-l-^&amp;(1+</span><span style="color:#ae81ff">\xb1\x9f</span><span style="color:#e6db74">^r</span><span style="color:#ae81ff">\xd5\x82</span><span style="color:#e6db74">,</span><span style="color:#ae81ff">\x97\xdc\xb4\xfe\x1c\x89</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\xaf\x1b\x17\x08</span><span style="color:#e6db74">v</span><span style="color:#ae81ff">\x08</span><span style="color:#e6db74">0</span><span style="color:#ae81ff">\x92\xfd\xe7\xc7</span><span style="color:#e6db74">j</span><span style="color:#ae81ff">\xf6</span><span style="color:#e6db74">Urg</span><span style="color:#ae81ff">\xe4\xb4\x8f\xf4</span><span style="color:#e6db74">C!</span><span style="color:#ae81ff">\xf3\xf3</span><span style="color:#e6db74">6F</span><span style="color:#ae81ff">\xc5</span><span style="color:#e6db74">&lt;_Y</span><span style="color:#ae81ff">\xb3\xbe\x12</span><span style="color:#e6db74">a</span><span style="color:#ae81ff">\x9b\x9b\xe9\x9c\x8c\x97\x93</span><span style="color:#e6db74">#</span><span style="color:#ae81ff">\xd0\xec\x87\x7f\xd1\xea</span><span style="color:#e6db74">(</span><span style="color:#ae81ff">\x94\x98\xa4\xc0\x1b\x04\xd0</span><span style="color:#e6db74">,</span><span style="color:#ae81ff">\xba</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\x0e\xfb</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\xc0</span><span style="color:#e6db74">5P</span><span style="color:#ae81ff">\x17\xbe</span><span style="color:#e6db74">(6&#34;</span><span style="color:#ae81ff">\xf7\xdd\xb2\xa5</span><span style="color:#e6db74">o</span><span style="color:#ae81ff">\x9f\xdc\xa0</span><span style="color:#e6db74">-@B</span><span style="color:#ae81ff">\x87\x9c</span><span style="color:#e6db74">L</span><span style="color:#ae81ff">\xf9\xfa\x8f\xcb\xf5</span><span style="color:#e6db74">)</span><span style="color:#ae81ff">\xd0</span><span style="color:#e6db74">H</span><span style="color:#ae81ff">\x84</span><span style="color:#e6db74">_vB</span><span style="color:#ae81ff">\xef\x1b</span><span style="color:#e6db74">e</span><span style="color:#ae81ff">\xb7</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\xc4\xa4\x7f</span><span style="color:#e6db74">K</span><span style="color:#ae81ff">\xd5\xe4\xea\x86\x18\xec\xcf</span><span style="color:#e6db74">!M</span><span style="color:#ae81ff">\x04</span><span style="color:#e6db74">r</span><span style="color:#ae81ff">\x96</span><span style="color:#e6db74">O</span><span style="color:#ae81ff">\xe1\x17\xb5\xf0\x19</span><span style="color:#e6db74">2</span><span style="color:#ae81ff">\xa5</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\xfe\x01\xca\xa4\xa8\xc4</span><span style="color:#e6db74">I</span><span style="color:#ae81ff">\x17</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\xa7\x9c</span><span style="color:#e6db74">W:</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">aoM</span><span style="color:#ae81ff">\x16\xbe\xb1\x8a\xec\xbe\xe7\x85\xbf</span><span style="color:#e6db74">K3u</span><span style="color:#ae81ff">\xa8\x80\xe5\xa2\x19\x17\t\x17\xa1\xf1</span><span style="color:#e6db74">A</span><span style="color:#ae81ff">\xd5</span><span style="color:#e6db74">j</span><span style="color:#ae81ff">\x18</span><span style="color:#e6db74">w{</span><span style="color:#ae81ff">\xee\x8f\xb4</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\xdd</span><span style="color:#e6db74">0}</span><span style="color:#ae81ff">\xb9</span><span style="color:#e6db74">2</span><span style="color:#ae81ff">\x9e\x8f\x87</span><span style="color:#e6db74">^</span><span style="color:#ae81ff">\xdc\xf6\xa4</span><span style="color:#e6db74">&gt;</span><span style="color:#ae81ff">\xf6\xfe\r\x0e\x9c\xc8</span><span style="color:#e6db74">j6</span><span style="color:#ae81ff">\xee\xdc\xe4</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\xd0</span><span style="color:#e6db74">dTo</span><span style="color:#ae81ff">\xc0\x87</span><span style="color:#e6db74">j</span><span style="color:#ae81ff">\xe1\x0c</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\xad\xc4</span><span style="color:#e6db74">B:</span><span style="color:#ae81ff">\xa1\xaf\xc7\xcc</span><span style="color:#e6db74">9</span><span style="color:#ae81ff">\xac</span><span style="color:#e6db74">0$p</span><span style="color:#ae81ff">\xed</span><span style="color:#e6db74">!</span><span style="color:#ae81ff">\xb7\xd2\xea\xdc\x86\xee</span><span style="color:#e6db74">s</span><span style="color:#ae81ff">\x92\xf8\xbc\x89</span><span style="color:#e6db74">H:</span><span style="color:#ae81ff">\x17\xae</span><span style="color:#e6db74">Ycgq</span><span style="color:#ae81ff">\x9c\xf5</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\xa8\t\xee</span><span style="color:#e6db74">~/5</span><span style="color:#ae81ff">\xf9</span><span style="color:#e6db74">@8q</span><span style="color:#ae81ff">\x97</span><span style="color:#e6db74">]</span><span style="color:#ae81ff">\x8d</span><span style="color:#e6db74">OM</span><span style="color:#ae81ff">\xcc\xc3\x14\x10</span><span style="color:#e6db74">8h</span><span style="color:#ae81ff">\xab</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\xec\xaa</span><span style="color:#e6db74">2</span><span style="color:#ae81ff">\xfc\t</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\x1e\xe8\x97</span><span style="color:#e6db74">;</span><span style="color:#ae81ff">\x15</span><span style="color:#e6db74">`</span><span style="color:#ae81ff">\xa1</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\x13\x7f\xfd\xe1\xd6\xb2\x0b\x13</span><span style="color:#e6db74">r</span><span style="color:#ae81ff">\xdd\xe6\xa3</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\xa7\t</span><span style="color:#e6db74">U</span><span style="color:#ae81ff">\xd0\x95\xcc\xb1\xef</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\x97\xc2\xed\xd1\x1e</span><span style="color:#e6db74">Vw</span><span style="color:#ae81ff">\t\xe4\xcb\xe6\xc9\x84</span><span style="color:#e6db74">B</span><span style="color:#ae81ff">\x8b\x7f</span><span style="color:#e6db74">w</span><span style="color:#ae81ff">\xa4\xbb</span><span style="color:#e6db74">8;</span><span style="color:#ae81ff">\xd9\xa1</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\x91</span><span style="color:#e6db74">Z</span><span style="color:#ae81ff">\x0b\x18\x08\xeb</span><span style="color:#e6db74">dgY</span><span style="color:#ae81ff">\xed</span><span style="color:#e6db74">8OY7</span><span style="color:#ae81ff">\xb4\x98\x0c</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\x9b</span><span style="color:#e6db74">+V</span><span style="color:#ae81ff">\x80</span><span style="color:#e6db74">6</span><span style="color:#ae81ff">\xa7\x91\xc8\x7f</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\xe5\xeb\x7f\xab\xe3\x1f\xed\xff\x8b\x7f\x1a</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\xf1\xd9\xd3\x03</span><span style="color:#e6db74">k</span><span style="color:#ae81ff">\x85</span><span style="color:#e6db74">e</span><span style="color:#ae81ff">\xa5\xe3</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\x05\x0f\xbf</span><span style="color:#e6db74">z=</span><span style="color:#ae81ff">\xa0\x0b\xc5\xec\x94</span><span style="color:#e6db74">X</span><span style="color:#ae81ff">\xd3\x1a\x1b\x19\x82\xbe</span><span style="color:#e6db74">3*</span><span style="color:#ae81ff">\xc7\x04\xd3\xda\xb8\xe0\xde\x88\xff\x83\xa0</span><span style="color:#e6db74">eh</span><span style="color:#ae81ff">\x10\xa2\xe9</span><span style="color:#e6db74">D</span><span style="color:#ae81ff">\x97\x1d</span><span style="color:#e6db74">u</span><span style="color:#ae81ff">\xb8\xda</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\x03\x08</span><span style="color:#e6db74">3</span><span style="color:#ae81ff">\xc8\x80</span><span style="color:#e6db74">nS</span><span style="color:#ae81ff">\xcc</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\x8b</span><span style="color:#e6db74">6z</span><span style="color:#ae81ff">\xef\xe7</span><span style="color:#e6db74">&gt;q</span><span style="color:#ae81ff">\x0e\xf9</span><span style="color:#e6db74">_</span><span style="color:#ae81ff">\x14</span><span style="color:#e6db74">S</span><span style="color:#ae81ff">\xcb\x9b\x14\xab\t\xc8\xd8</span><span style="color:#e6db74">e </span><span style="color:#ae81ff">\xad</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\xa2\x84</span><span style="color:#e6db74">f</span><span style="color:#ae81ff">\xf1\x08</span><span style="color:#e6db74">R</span><span style="color:#ae81ff">\x88\x9f\x97</span><span style="color:#e6db74">60J</span><span style="color:#ae81ff">\\\x07\xb3\x01</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\x01\x94</span><span style="color:#e6db74">U</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">Us4</span><span style="color:#ae81ff">\x1b\x08\xe8\x7f\x07\xec</span><span style="color:#e6db74">r$</span><span style="color:#ae81ff">\xd0</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\x8c\xb5\xe8\x03\xa8\x95\xa8</span><span style="color:#e6db74">~</span><span style="color:#ae81ff">\x1a\xff</span><span style="color:#e6db74">#|</span><span style="color:#ae81ff">\xa6\r</span><span style="color:#e6db74">Qg</span><span style="color:#ae81ff">\xee\xe7\x90\x08\xda</span><span style="color:#e6db74">,oD</span><span style="color:#ae81ff">\x91\x88</span><span style="color:#e6db74">wr</span><span style="color:#ae81ff">\xf5\x1a\xa1\xa3\xb2\xa0\xa4\xf6</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\x9d\xa0</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\x95\x80\x86\x8b\xef\x98\x8e\xb0\xc0\xde</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\xf6\x0f\xa1\xc9\x8b\n\x10\x8d\x8b\xcb</span><span style="color:#e6db74">!</span><span style="color:#ae81ff">\x9e\xf2\x05\x94</span><span style="color:#e6db74">`U</span><span style="color:#ae81ff">\xe4\xe6\xc8\x88</span><span style="color:#e6db74">Kk</span><span style="color:#ae81ff">\xeb\x1f\x98</span><span style="color:#e6db74">,|]</span><span style="color:#ae81ff">\x9c\xa2\x9d\xcc\x15\x93\xae\x08\x06\x88</span><span style="color:#e6db74">t</span><span style="color:#ae81ff">\x8e</span><span style="color:#e6db74">z^3</span><span style="color:#ae81ff">\xaf\xd0\xf5</span><span style="color:#e6db74">0</span><span style="color:#ae81ff">\x11</span><span style="color:#e6db74">i</span><span style="color:#ae81ff">\xa2</span><span style="color:#e6db74">=</span><span style="color:#ae81ff">\xca\xb4</span><span style="color:#e6db74">/</span><span style="color:#ae81ff">\xa4\x1b</span><span style="color:#e6db74">2.AyM</span><span style="color:#ae81ff">\xc3</span><span style="color:#e6db74">Q</span><span style="color:#ae81ff">\&#39;\xbd</span><span style="color:#e6db74">k</span><span style="color:#ae81ff">\xfb\xec\x9a</span><span style="color:#e6db74">q</span><span style="color:#ae81ff">\xb8</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\x80</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">\xd3\xf9\xb8\x0b\x84</span><span style="color:#e6db74">1</span><span style="color:#ae81ff">\xf1\x15\xa0</span><span style="color:#e6db74">I</span><span style="color:#ae81ff">\xbb</span><span style="color:#e6db74">G</span><span style="color:#ae81ff">\x82</span><span style="color:#e6db74">4</span><span style="color:#ae81ff">\xe6</span><span style="color:#e6db74">;p</span><span style="color:#ae81ff">\xd1\xa5</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\xc8\xb8</span><span style="color:#e6db74">O</span><span style="color:#ae81ff">\xa3</span><span style="color:#e6db74">TK</span><span style="color:#ae81ff">\x88\xec\xca\xb3</span><span style="color:#e6db74">(</span><span style="color:#ae81ff">\x7f\x16</span><span style="color:#e6db74">z</span><span style="color:#ae81ff">\xd5\xa6\x08</span><span style="color:#e6db74">kQ</span><span style="color:#ae81ff">\xb6\xce\xe2\t\xa0\x17\xd4</span><span style="color:#e6db74">(&#39;</span>
    var12 <span style="color:#f92672">=</span> len(var11)
    var13 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#66d9ef">for</span> var15 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, var12):
        var13 <span style="color:#f92672">+=</span> chr(ord(var11[var15]) <span style="color:#f92672">^</span> ord(var8[(var15 <span style="color:#f92672">%</span> var10)]))

    var13 <span style="color:#f92672">=</span> marshal<span style="color:#f92672">.</span>loads(zlib<span style="color:#f92672">.</span>decompress(base64<span style="color:#f92672">.</span>b64decode(var13)))
    <span style="color:#66d9ef">exec</span> var13
    <span style="color:#66d9ef">exec</span> var21(var6)
    <span style="color:#66d9ef">del</span> var8
    <span style="color:#66d9ef">del</span> var10
    <span style="color:#66d9ef">del</span> var11
    <span style="color:#66d9ef">del</span> var12
    <span style="color:#66d9ef">del</span> var13
    <span style="color:#66d9ef">del</span> var15
    <span style="color:#66d9ef">del</span> var6
    <span style="color:#66d9ef">del</span> var21
<span style="color:#66d9ef">except</span>:
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;An uncorrectable error has occurred while loading module.&#39;</span>

var21 <span style="color:#f92672">=</span> var22
<span style="color:#66d9ef">del</span> var21
</code></pre></div><p>Interesting! The next stage has actually been zlib compressed, base64 encoded, then <code>XOR</code>'d with the current function&rsquo;s (original) bytecode.</p>
<p>By pulling the obfuscated stage2 data directly out of the <code>co2.co_consts</code>, we can easily replicate this logic and get our stage2 code object:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># TODO: Not sure it the const index is always the same,</span>
<span style="color:#75715e"># may need to grab this by finding the largest const.</span>
stage2_enc_code <span style="color:#f92672">=</span> co2<span style="color:#f92672">.</span>co_consts[<span style="color:#ae81ff">2</span>] 
stage2_out_code <span style="color:#f92672">=</span> bytearray()

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(stage2_enc_code)):
    stage2_out_code<span style="color:#f92672">.</span>append(stage2_enc_code[i] <span style="color:#f92672">^</span> original_co_code[i <span style="color:#f92672">%</span> len(original_co_code)])

stage2_co2 <span style="color:#f92672">=</span> xdis<span style="color:#f92672">.</span>marsh<span style="color:#f92672">.</span>loads(zlib<span style="color:#f92672">.</span>decompress(base64<span style="color:#f92672">.</span>b64decode(stage2_out_code)), version)
</code></pre></div><hr>
<h2 id="stage-2">Stage 2</h2>
<p>Another stage, let&rsquo;s start from the beginning.</p>
<p>First things first, does <em>this</em> code object decompile normally? <!-- raw HTML omitted -->No.<!-- raw HTML omitted --></p>
<p>So let&rsquo;s take a look at the first instruction(s):</p>
<pre><code>0: JUMP_FORWARD 40
3: DELETE_GLOBAL 57417
6: BUILD_CLASS None
7: DUP_TOP None
8: INPLACE_ADD None
9: &lt;160&gt; 10939
12: END_FINALLY None
13: SLICE+3 None
14: &lt;157&gt; 13350
17: &lt;49&gt; None
18: &lt;178&gt; 27297
</code></pre><p>That looks familiar. Let&rsquo;s just try reusing our existing jump+junk <code>NOP</code> replacement and offset fixing code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Replace the jump+junk anti-disassembler instructions with NOP.</span>
nop_jump_junk(stage2_co2, opc)

<span style="color:#75715e"># Remove the NOP&#39;s and recalculate the offsets.</span>
stage2_co2 <span style="color:#f92672">=</span> remove_nops(stage2_co2, opc, version)

uncompyle6<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>decompile(<span style="color:#ae81ff">2.7</span>, stage2_co2, sys<span style="color:#f92672">.</span>stdout)
</code></pre></div><p>Oh, that worked!</p>
<pre><code># uncompyle6 version 3.5.0
# Python bytecode 2.7
# Decompiled from: Python 3.7.1 (v3.7.1:260ec2c36a, Oct 20 2018, 14:57:15) [MSC v.1915 64 bit (AMD64)]
# Embedded file name: pyprotect.angelic47.com
import zlib, marshal, types, base64

def pyopencoder_opDecoder(pyopencoder_codeobj):
    pyopencoder_keyData = base64.b64decode(b'81xT+JWBWSfSJf/K1N4Yn51PUgyg+NdA55azqVBzf8qqddBntwXJpUcbPd/r6FqN0PYmJefGkv/1uWYpQRlFbz6eYGbG/zfRMqW2J3EXfIVj3hMFtB/w+qVGPqK38tlW02NqFFEAyL/w96a1zpjR9KhUj/e9nSB7csBk8LfNNL4y1tD7jB+CM84tQYj4qW3v7qI7BRqcIbuKDrG7MwZ6gnfjJwXPURPp6f8vcB7wsZMuHJ0=')
    pyopencoder_keyLen = len(pyopencoder_keyData)
    pyopencoder_packKey = base64.b64decode(b'kwGvLZqhKne0RXCCI2WsigLHJ8LK0uah5dWu9ralbz0CX72uSG2j88zWP4TqdULtgG3i3N0HH+UbBvB5O4igKsUbIal6M25tdWqfFrqXwGf6oDwIh6vAZA/sQUDcf8iqyS9Tw3ic4+Yq0jBS7qqdUXXzsg8vp/rf2P5gEGjCH78/sWR4csr5BlhW5GphauFG/Gl77VM9plqqtrxAvX+wGoy6')
    pyopencoder_packKeyLen = len(pyopencoder_packKey)
    pyopencoder_opData = pyopencoder_codeobj.co_code.split(b'\xff\xaa9P\x13f\xfa\xde', 1)[1][:-1]
    pyopencoder_newOpData = ''
    pyopencoder_lenOpData = len(pyopencoder_opData)
    for pyopencoder_i in range(0, pyopencoder_lenOpData):
        pyopencoder_newOpData += chr(ord(pyopencoder_opData[pyopencoder_i]) ^ ord(pyopencoder_packKey[(pyopencoder_i % pyopencoder_packKeyLen)]))

    pyopencoder_codeobj1 = marshal.loads(zlib.decompress(pyopencoder_newOpData))
    pyopencoder_opData = pyopencoder_codeobj1.co_code
    pyopencoder_newOpData = ''
    pyopencoder_lenOpData = len(pyopencoder_opData)
    for pyopencoder_i in range(0, pyopencoder_lenOpData):
        pyopencoder_newOpData += chr(ord(pyopencoder_opData[pyopencoder_i]) ^ ord(pyopencoder_keyData[(pyopencoder_i % pyopencoder_keyLen)]))

    pyopencoder_codeObject = types.CodeType(pyopencoder_codeobj1.co_argcount, pyopencoder_codeobj1.co_nlocals, pyopencoder_codeobj1.co_stacksize, pyopencoder_codeobj1.co_flags, pyopencoder_newOpData, pyopencoder_codeobj1.co_consts, pyopencoder_codeobj1.co_names, pyopencoder_codeobj1.co_varnames, pyopencoder_codeobj1.co_filename, pyopencoder_codeobj1.co_name, pyopencoder_codeobj1.co_firstlineno, pyopencoder_codeobj1.co_lnotab)
    del pyopencoder_keyData
    del pyopencoder_keyLen
    del pyopencoder_packKey
    del pyopencoder_packKeyLen
    del pyopencoder_opData
    del pyopencoder_newOpData
    del pyopencoder_lenOpData
    del pyopencoder_codeobj1
    del pyopencoder_i
    return pyopencoder_codeObject
</code></pre><p>But wait, let&rsquo;s take a quick detour, something is wrong. Looking back at our decompiled stage1 snippet, some code was supposed to run first (<code>var13</code>), set our <code>var21</code> variable (originally called <code>'from or exec'</code>) to a function, presumably this <code>pyopencoder_opDecoder</code> we&rsquo;ve just decompiled, and then call that function.</p>
<pre><code>var13 = marshal.loads(zlib.decompress(base64.b64decode(var13)))
exec var13
exec var21(var6)
</code></pre><p>So what happened to the <code>var13</code> code? Let&rsquo;s print our <code>stage2_co2</code> object and take a look.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pprint <span style="color:#f92672">import</span> pprint
pprint(vars(stage2_co2))
</code></pre></div><p><img src="image6.png" alt="printing stage2_co2&rsquo;s vars"></p>
<p>Well this doesn&rsquo;t <em>look</em> like what we just decompiled. This has a fairly small amount of bytes in <code>co_code</code> and it actually uses the <code>var21/'from or exec'</code> as well. I think that the <code>xdis.code.Code2</code> object in the <code>co_consts</code> is the function that got decompiled above, let&rsquo;s check by printing that also.</p>
<p><img src="image7.png" alt="printing the other code object"></p>
<p>I tried many different things to get this to decompile completely, such as changing the code object flags, replacing the function&rsquo;s <code>co_code</code> with bytecode from a py2.7 stub function, etc. However, after an hour with no progress, I finally gave up on the <!-- raw HTML omitted -->_automatic_<!-- raw HTML omitted --> decompilation of this part.</p>
<p>With that said, let&rsquo;s take a look at the disassembly and see where <code>uncompyle6</code> is having issues.</p>
<pre><code>xdis.main.disco(version, stage2_co2, 0)
</code></pre><pre><code># Method Name:       b'PyProtect Protection Object'
# Filename:          pyprotect.angelic47.com
# Argument count:    0
# Number of locals:  0
# Stack size:        2
# Flags:             0x00000040 (NOFREE)
# First Line:        2
# Constants:
#    0: -1
#    1: None
#    2: &lt;xdis.code.Code2 object at 0x000001EDEB832940&gt;
# Names:
#    0: zlib
#    1: marshal
#    2: types
#    3: base64
#    4: from or exec
  2:           0 LOAD_CONST                0 (-1)
               3 LOAD_CONST                1 (None)
               6 IMPORT_NAME               0 (zlib)
               9 STORE_NAME                0 (zlib)
              12 LOAD_CONST                0 (-1)
              15 LOAD_CONST                1 (None)
              18 IMPORT_NAME               1 (marshal)
              21 STORE_NAME                1 (marshal)
              24 LOAD_CONST                0 (-1)
              27 LOAD_CONST                1 (None)
              30 IMPORT_NAME               2 (types)
              33 STORE_NAME                2 (types)
              36 LOAD_CONST                0 (-1)
              39 LOAD_CONST                1 (None)
              42 IMPORT_NAME               3 (base64)
              45 STORE_NAME                3 (base64)

  3:          48 LOAD_CONST                2 (&lt;xdis.code.Code2 object at 0x000001EDEB832940&gt;)
              51 MAKE_FUNCTION             0
              54 STORE_NAME                4 (from or exec)
              57 LOAD_CONST                1 (None)
              60 RETURN_VALUE
</code></pre><p>Suprisingly, it&rsquo;s actually not that much different from what <code>uncompyle6</code> gave us:</p>
<ol>
<li>
<p>Instructions 0 ~ 45 just import <code>zlib</code>, <code>marshal</code>, <code>types</code>, and <code>base64</code>.</p>
</li>
<li>
<p>Instructions 48 &amp; 51 load the function code object from <code>co_consts</code> and make the function in the python VM.</p>
</li>
<li>
<p>This is the part that <code>uncompyle6</code> missed. Instructions 54 ~ 60 take the return value from <code>MAKE_FUNCTION</code> and store it in our <code>var21/'from or exec'</code>, then returns <code>None</code>.</p>
</li>
</ol>
<p>Essentially, <code>uncompyle6</code> has only missed one important line:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> zlib<span style="color:#f92672">,</span> marshal<span style="color:#f92672">,</span> types<span style="color:#f92672">,</span> base64 <span style="color:#75715e"># Same as uncompyle6</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pyopencoder_opDecoder</span>(pyopencoder_codeobj): <span style="color:#75715e"># Same as uncompyle6</span>
    <span style="color:#75715e"># ... snip ...</span>

var21 <span style="color:#f92672">=</span> pyopencoder_opDecoder <span style="color:#75715e"># Missing from uncompyle6 output</span>
<span style="color:#66d9ef">return</span> None
</code></pre></div><p>I haven&rsquo;t looked into why <code>uncompyle6</code> acts this way, but I assume that it must not be able to handle things using the return value from <code>MAKE_FUNCTION</code>, as it can handle other files with function definitions normally.</p>
<p>Now that we know it&rsquo;s not doing anything else tricky, we can move on with our decompiled code. The decompiled code itself it perfectly readable, but it&rsquo;s worth going over what it&rsquo;s generally doing.</p>
<p>First, it loads two XOR keys. One to decode a marshalled code object (<code>pyopencoder_keyData</code>), and another to decode the <code>co_code</code> within the marshalled code object (<code>pyopencoder_packKey </code>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ef pyopencoder_opDecoder(pyopencoder_codeobj):
    pyopencoder_keyData <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;81xT+JWBWSfS...&#39;</span>) 
    pyopencoder_packKey <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;kwGvLZqhKne0...&#39;</span>)
</code></pre></div><p>Second, it takes the very first code object from stage1 (named as <code>pyopencoder_codeobj</code> here), splits it by some bytes, and takes the data up to <code>length-1</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pyopencoder_opData <span style="color:#f92672">=</span> pyopencoder_codeobj<span style="color:#f92672">.</span>co_code<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xff\xaa</span><span style="color:#e6db74">9P</span><span style="color:#ae81ff">\x13</span><span style="color:#e6db74">f</span><span style="color:#ae81ff">\xfa\xde</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">1</span>][:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</code></pre></div><p>In fact, this happens to be the &ldquo;junk&rdquo; data from the stage1&rsquo;s second anti-disassembly jump. The split takes place right after the PyProtect header, and the data goes to [:-1] because of the <code>NOP</code> at the end for the jump.</p>
<p><img src="image8.png" alt="the split data after the pyprotect header in our hex editor"></p>
<p>Then the split data goes through a XOR loop, gets zlib decompressed, then unmarshalled as a code object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pyopencoder_newOpData <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
pyopencoder_lenOpData <span style="color:#f92672">=</span> len(pyopencoder_opData)
<span style="color:#66d9ef">for</span> pyopencoder_i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, pyopencoder_lenOpData):
    pyopencoder_newOpData <span style="color:#f92672">+=</span> chr(ord(pyopencoder_opData[pyopencoder_i]) <span style="color:#f92672">^</span> ord(pyopencoder_packKey[(pyopencoder_i <span style="color:#f92672">%</span> pyopencoder_packKeyLen)]))

pyopencoder_codeobj1 <span style="color:#f92672">=</span> marshal<span style="color:#f92672">.</span>loads(zlib<span style="color:#f92672">.</span>decompress(pyopencoder_newOpData))
</code></pre></div><p>From there, the unmarshalled code object&rsquo;s <code>co_code</code> goes through <em>another</em> XOR loop to decrypt it, and then the code object is reconstructed with the final decrypted code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pyopencoder_opData <span style="color:#f92672">=</span> pyopencoder_codeobj1<span style="color:#f92672">.</span>co_code
pyopencoder_newOpData <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
pyopencoder_lenOpData <span style="color:#f92672">=</span> len(pyopencoder_opData)
<span style="color:#66d9ef">for</span> pyopencoder_i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, pyopencoder_lenOpData):
    pyopencoder_newOpData <span style="color:#f92672">+=</span> chr(ord(pyopencoder_opData[pyopencoder_i]) <span style="color:#f92672">^</span> ord(pyopencoder_keyData[(pyopencoder_i <span style="color:#f92672">%</span> pyopencoder_keyLen)]))

pyopencoder_codeObject <span style="color:#f92672">=</span> types<span style="color:#f92672">.</span>CodeType(
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_argcount,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_nlocals,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_stacksize,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_flags,
    pyopencoder_newOpData,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_consts,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_names,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_varnames,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_filename,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_name,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_firstlineno,
    pyopencoder_codeobj1<span style="color:#f92672">.</span>co_lnotab)
</code></pre></div><hr>
<p>For the purposed of our unpack script, we can rip the keys out from the function code object&rsquo;s <code>co_consts</code> and then almost directly copy the decompiled code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Get the consts from the `pyopencoder_opDecoder` function code object.</span>
decode_func_consts <span style="color:#f92672">=</span> stage2_co2<span style="color:#f92672">.</span>co_consts[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>co_consts

<span style="color:#75715e"># Copy the code from the decompiled version,</span>
<span style="color:#75715e"># using the keys right out of the `co_consts`.</span>
code_key <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(decode_func_consts[<span style="color:#ae81ff">1</span>])
obj_key <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(decode_func_consts[<span style="color:#ae81ff">2</span>])
split_by <span style="color:#f92672">=</span> decode_func_consts[<span style="color:#ae81ff">3</span>]

<span style="color:#75715e"># Decrypt the code object.</span>
<span style="color:#75715e"># This contains the co_const, co_name, etc.</span>
<span style="color:#75715e"># This object&#39;s `co_code` is encrypted.</span>
encrypted_obj <span style="color:#f92672">=</span> original_co_code<span style="color:#f92672">.</span>split(split_by, <span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">1</span>][:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
decrypted_obj <span style="color:#f92672">=</span> bytearray()
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(encrypted_obj)):
    decrypted_obj<span style="color:#f92672">.</span>append(encrypted_obj[i] <span style="color:#f92672">^</span> obj_key[i<span style="color:#f92672">%</span>len(obj_key)])

stage3_out_code <span style="color:#f92672">=</span> xdis<span style="color:#f92672">.</span>marsh<span style="color:#f92672">.</span>loads(zlib<span style="color:#f92672">.</span>decompress(decrypted_obj), version)

<span style="color:#75715e"># Decrypt the `co_code`.</span>
encrypted_code <span style="color:#f92672">=</span> stage3_out_code<span style="color:#f92672">.</span>co_code
decrypted_code <span style="color:#f92672">=</span> bytearray()
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(encrypted_code)):
    decrypted_code<span style="color:#f92672">.</span>append(encrypted_code[i] <span style="color:#f92672">^</span> code_key[i<span style="color:#f92672">%</span>len(code_key)])

<span style="color:#75715e"># Because we are using `xdis`, </span>
<span style="color:#75715e"># we can just set the co_code back onto the object instead of wrapping it.</span>
stage3_out_code<span style="color:#f92672">.</span>co_code <span style="color:#f92672">=</span> decrypted_code
stage3_out_code<span style="color:#f92672">.</span>freeze()
</code></pre></div><h2 id="stage-3">Stage 3</h2>
<p>Now we&rsquo;re finally on to the third, and hopefully last, stage. So once again, let&rsquo;s start over.</p>
<p>Does it decompile normally? <!-- raw HTML omitted -->No.<!-- raw HTML omitted --></p>
<pre><code>IndexError: tuple index out of range
</code></pre><p>Does it have anti-disassembly jumps at the beginning of <code>co_code</code>? <!-- raw HTML omitted -->Yes!<!-- raw HTML omitted --></p>
<pre><code>0: JUMP_FORWARD 33
3: DELETE_GLOBAL 38380
6: IMPORT_NAME 27662
9: &lt;237&gt; 45956
12: &lt;139&gt; 61372
</code></pre><p>Does it decompile after using our existing jump+junk <code>NOP</code> replacement and offset fixing code? <!-- raw HTML omitted -->No.<!-- raw HTML omitted --></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Replace the jump+junk anti-disassembler instructions with NOP.</span>
nop_jump_junk(stage3_co2, opc)

<span style="color:#75715e"># Remove the NOP&#39;s and recalculate the offsets.</span>
co2 <span style="color:#f92672">=</span> remove_nops(stage3_co2, opc, version)

uncompyle6<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>decompile(<span style="color:#ae81ff">2.7</span>, stage3_co2, sys<span style="color:#f92672">.</span>stdout)
</code></pre></div><pre><code>TypeError: can only concatenate str (not &quot;bytes&quot;) to str
</code></pre><p>So what is going on here? If we disassemble it with <code>xdis</code>, two things quickly become apparent.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">xdis<span style="color:#f92672">.</span>main<span style="color:#f92672">.</span>disco(version, stage3_co2, <span style="color:#ae81ff">0</span>)
</code></pre></div><pre><code># (A lot of verbose output snipped)

# Method Name:       b'PyProtect Protection Object'
... snip...
# Constants:
#    0: -1
#    1: None
#    2: 'Human'
#    3: &lt;xdis.code.Code2 object at 0x000001AFD7693128&gt;
#    4: &lt;xdis.code.Code2 object at 0x000001AFD7693198&gt;
#    5: 'Aarav'
#    6: 17
#    7: 'Jane'
#    8: 19
#    9: 'Yoshi'
... snip ...

# Method Name:       b'PyProtect Protection Object'
... snip ...
  3:           0 JUMP_FORWARD             30 (to 33)
               3 DELETE_GLOBAL         38380 (38380)
... snip ...

# Method Name:       b'PyProtect Protection Object'
... snip ...
  5:           0 JUMP_FORWARD             39 (to 42)
               3 DELETE_GLOBAL         45323 (45323)
... snip ...

# Method Name:       b'PyProtect Protection Object'
 16:           0 JUMP_FORWARD             28 (to 31)
               3 DELETE_GLOBAL         56625 (56625)
... snip ...

# Method Name:       b'PyProtect Protection Object'
... snip ...
  7:           0 JUMP_FORWARD             23 (to 26)
               3 DELETE_GLOBAL         43655 (43655)
... snip ...

# Method Name:       b'PyProtect Protection Object'
... snip ...
 11:           0 JUMP_FORWARD             27 (to 30)
               3 DELETE_GLOBAL         36813 (36813)
... snip ...
</code></pre><p>First, based on the constants being used, we are likely at the code for the original python example script that we started with. Second, there are multiple code objects being used for classes and functions, and they all have the anti-disassembly jumps on them.</p>
<p>To fix this, we just have to recursively remove the jumps from the code objects in <code>co_consts</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recursive_fix_stage3</span>(co2):
    <span style="color:#75715e"># Replace the jump+junk anti-disassembler instructions with NOP.</span>
    nop_jump_junk(co2, opc)

    <span style="color:#75715e"># Remove the NOP&#39;s and recalculate the offsets.</span>
    co2 <span style="color:#f92672">=</span> remove_nops(co2, opc, version)

    <span style="color:#75715e"># Recursively fix up the code objects in `co_consts`</span>
    consts <span style="color:#f92672">=</span> list(co2<span style="color:#f92672">.</span>co_consts)
    <span style="color:#66d9ef">for</span> (k, v) <span style="color:#f92672">in</span> enumerate(consts):
        <span style="color:#66d9ef">if</span> xdis<span style="color:#f92672">.</span>code<span style="color:#f92672">.</span>iscode(v) <span style="color:#f92672">and</span> <span style="color:#e6db74">&#39;pyprotect&#39;</span> <span style="color:#f92672">in</span> v<span style="color:#f92672">.</span>co_filename:
            consts[k] <span style="color:#f92672">=</span> recursive_fix_stage3(v)

    co2<span style="color:#f92672">.</span>co_consts <span style="color:#f92672">=</span> tuple(consts)
    co2<span style="color:#f92672">.</span>freeze()

    <span style="color:#66d9ef">return</span> co2

stage3_co2 <span style="color:#f92672">=</span> recursive_fix_stage3(stage3_co2)
</code></pre></div><p>The disassembly is clean now, but <code>uncompyle6</code> still fails. If we pay closer attention to the error this time, it actually turns out to just be <code>uncompyle6</code> expecting <code>co_name</code> to be of type <code>str</code> instead of <code>bytes</code> for a Python2 code object.</p>
<pre><code>  File &quot;C:\Python37\lib\site-packages\uncompyle6\scanners\scanner2.py&quot;, line 297, in ingest
    pattr = '&lt;code_object ' + const.co_name + '&gt;'
TypeError: can only concatenate str (not &quot;bytes&quot;) to str
</code></pre><p>We can easily work around this by converting the names from bytes to str in our recursive function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recursive_fix_stage3</span>(co2):
    co2<span style="color:#f92672">.</span>co_name <span style="color:#f92672">=</span> str(co2<span style="color:#f92672">.</span>co_name)
    <span style="color:#f92672">...</span> snip <span style="color:#f92672">...</span>
</code></pre></div><p>With that, we can now get really close to our original source code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># uncompyle6 version 3.5.0</span>
<span style="color:#75715e"># Python bytecode 2.7</span>
<span style="color:#75715e"># Decompiled from: Python 3.7.1 (v3.7.1:260ec2c36a, Oct 20 2018, 14:57:15) [MSC v.1915 64 bit (AMD64)]</span>
<span style="color:#75715e"># Embedded file name: pyprotect.angelic47.com</span>
<span style="color:#f92672">import</span> random

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Human</span>(object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;PyProtect Protection Object&#39;</span>(self, name, age):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>age <span style="color:#f92672">=</span> age

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;PyProtect Protection Object&#39;</span>(self):
        self<span style="color:#f92672">.</span>age <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">print</span> (<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Happy birthday {}!&#39;</span>)<span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>name)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;PyProtect Protection Object&#39;</span>(human):
    <span style="color:#66d9ef">return</span> human<span style="color:#f92672">.</span>age <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">21</span>


humans <span style="color:#f92672">=</span> [
 Human(<span style="color:#e6db74">&#39;Aarav&#39;</span>, <span style="color:#ae81ff">17</span>),
 Human(<span style="color:#e6db74">&#39;Jane&#39;</span>, <span style="color:#ae81ff">19</span>),
 Human(<span style="color:#e6db74">&#39;Yoshi&#39;</span>, <span style="color:#ae81ff">27</span>),
 Human(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;G</span><span style="color:#ae81ff">\xc3\xbc</span><span style="color:#e6db74">nay&#39;</span>, <span style="color:#ae81ff">20</span>),
 Human(<span style="color:#e6db74">&#39;Cody&#39;</span>, <span style="color:#ae81ff">17</span>)]
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">5</span>):
    <span style="color:#66d9ef">for</span> human <span style="color:#f92672">in</span> humans:
        human<span style="color:#f92672">.</span>have_birthday()

    human <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice(humans)
    classification <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adult&#39;</span> <span style="color:#66d9ef">if</span> is_adult(human) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;minor&#39;</span>
    <span style="color:#66d9ef">print</span> (<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;{} died as a {} at the age of {}.&#39;</span>)<span style="color:#f92672">.</span>format(human<span style="color:#f92672">.</span>name, classification, human<span style="color:#f92672">.</span>age)
    humans<span style="color:#f92672">.</span>remove(human)
</code></pre></div><p>Where have our function names gone though?</p>
<p>If we disassemble it again with <code>xdis</code>, we find that this is actually the same <code>uncompyle6</code> issue/possible anti-decompilation technique that we saw with <code>MAKE_FUNCTION</code> in stage2:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Method Name:       b&#39;PyProtect Protection Object&#39;</span>
<span style="color:#75715e"># Filename:          pyprotect.angelic47.com</span>
<span style="color:#75715e"># Argument count:    0</span>
<span style="color:#75715e"># Number of locals:  0</span>
<span style="color:#75715e"># Stack size:        1</span>
<span style="color:#75715e"># Flags:             0x00000042 (NOFREE | NEWLOCALS)</span>
<span style="color:#75715e"># First Line:        5</span>
<span style="color:#75715e"># Constants:</span>
<span style="color:#75715e">#    0: &lt;xdis.code.Code2 object at 0x000002A3DD3E1BA8&gt;</span>
<span style="color:#75715e">#    1: &lt;xdis.code.Code2 object at 0x000002A3DD3E1C18&gt;</span>
<span style="color:#75715e"># Names:</span>
<span style="color:#75715e">#    0: __name__</span>
<span style="color:#75715e">#    1: __module__</span>
<span style="color:#75715e">#    2: __init__</span>
<span style="color:#75715e">#    3: have_birthday</span>
  <span style="color:#ae81ff">5</span>:           <span style="color:#ae81ff">0</span> LOAD_NAME                 <span style="color:#ae81ff">0</span> (__name__)
               <span style="color:#ae81ff">3</span> STORE_NAME                <span style="color:#ae81ff">1</span> (__module__)

  <span style="color:#ae81ff">6</span>:           <span style="color:#ae81ff">6</span> LOAD_CONST                <span style="color:#ae81ff">0</span> (<span style="color:#f92672">&lt;</span>xdis<span style="color:#f92672">.</span>code<span style="color:#f92672">.</span>Code2 object at <span style="color:#ae81ff">0x000002A3DD3E1BA8</span><span style="color:#f92672">&gt;</span>)
               <span style="color:#ae81ff">9</span> MAKE_FUNCTION             <span style="color:#ae81ff">0</span>
              <span style="color:#ae81ff">12</span> STORE_NAME                <span style="color:#ae81ff">2</span> (__init__)

 <span style="color:#ae81ff">10</span>:          <span style="color:#ae81ff">15</span> LOAD_CONST                <span style="color:#ae81ff">1</span> (<span style="color:#f92672">&lt;</span>xdis<span style="color:#f92672">.</span>code<span style="color:#f92672">.</span>Code2 object at <span style="color:#ae81ff">0x000002A3DD3E1C18</span><span style="color:#f92672">&gt;</span>)
              <span style="color:#ae81ff">18</span> MAKE_FUNCTION             <span style="color:#ae81ff">0</span>
              <span style="color:#ae81ff">21</span> STORE_NAME                <span style="color:#ae81ff">3</span> (have_birthday)
              <span style="color:#ae81ff">24</span> LOAD_LOCALS
              <span style="color:#ae81ff">25</span> RETURN_VALUE
</code></pre></div><p>Instead of the function code objects having valid <code>co_name</code> values, they all share the same generic <code>b'PyProtect Protection Object'</code>, and then upon being created with <code>MAKE_FUNCTION</code>, the return value gets stored in the original proper name.</p>
<p>To fix this, we have to go over each code object recursively, disassemble them and find pairs of (<code>LOAD_CONST</code>+<code>MAKE_FUNCTION</code>+<code>STORE_NAME</code>), parse out the name -&gt; code object mapping, and then set the proper <code>co_name</code> on them.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recursive_fix_stage3</span>(co2):
    co2<span style="color:#f92672">.</span>co_name <span style="color:#f92672">=</span> str(co2<span style="color:#f92672">.</span>co_name)

    <span style="color:#75715e"># Replace the jump+junk anti-disassembler instructions with NOP.</span>
    nop_jump_junk(co2, opc)

    <span style="color:#75715e"># Remove the NOP&#39;s and recalculate the offsets.</span>
    co2 <span style="color:#f92672">=</span> remove_nops(co2, opc, version)

    insts <span style="color:#f92672">=</span> list(get_instructions_bytes(co2, opc))
    <span style="color:#66d9ef">for</span> (k, v) <span style="color:#f92672">in</span> enumerate(insts):
        <span style="color:#66d9ef">if</span> (insts[k<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>opname <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;LOAD_CONST&#39;</span> <span style="color:#f92672">and</span>
            insts[k<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>opname <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;MAKE_FUNCTION&#39;</span> <span style="color:#f92672">and</span>
            insts[k<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>opname <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;STORE_NAME&#39;</span> ):
            co2<span style="color:#f92672">.</span>co_consts[insts[k<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>arg]<span style="color:#f92672">.</span>co_name <span style="color:#f92672">=</span> str(co2<span style="color:#f92672">.</span>co_names[insts[k<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>arg]) 

    <span style="color:#75715e"># Recursively fix up the code objects in `co_consts`</span>
    consts <span style="color:#f92672">=</span> list(co2<span style="color:#f92672">.</span>co_consts)
    <span style="color:#66d9ef">for</span> (k, v) <span style="color:#f92672">in</span> enumerate(consts):
        <span style="color:#66d9ef">if</span> xdis<span style="color:#f92672">.</span>code<span style="color:#f92672">.</span>iscode(v) <span style="color:#f92672">and</span> <span style="color:#e6db74">&#39;pyprotect&#39;</span> <span style="color:#f92672">in</span> v<span style="color:#f92672">.</span>co_filename:
            consts[k] <span style="color:#f92672">=</span> recursive_fix_stage3(v)

    co2<span style="color:#f92672">.</span>co_consts <span style="color:#f92672">=</span> tuple(consts)
    co2<span style="color:#f92672">.</span>freeze()

    <span style="color:#66d9ef">return</span> co2
</code></pre></div><p>And with that, our original source code has been decompiled!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># uncompyle6 version 3.5.0</span>
<span style="color:#75715e"># Python bytecode 2.7</span>
<span style="color:#75715e"># Decompiled from: Python 3.7.1 (v3.7.1:260ec2c36a, Oct 20 2018, 14:57:15) [MSC v.1915 64 bit (AMD64)]</span>
<span style="color:#75715e"># Embedded file name: pyprotect.angelic47.com</span>
<span style="color:#f92672">import</span> random

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Human</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, name, age):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>age <span style="color:#f92672">=</span> age

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">have_birthday</span>(self):
        self<span style="color:#f92672">.</span>age <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">print</span> (<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Happy birthday {}!&#39;</span>)<span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>name)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_adult</span>(human):
    <span style="color:#66d9ef">return</span> human<span style="color:#f92672">.</span>age <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">21</span>


humans <span style="color:#f92672">=</span> [
 Human(<span style="color:#e6db74">&#39;Aarav&#39;</span>, <span style="color:#ae81ff">17</span>),
 Human(<span style="color:#e6db74">&#39;Jane&#39;</span>, <span style="color:#ae81ff">19</span>),
 Human(<span style="color:#e6db74">&#39;Yoshi&#39;</span>, <span style="color:#ae81ff">27</span>),
 Human(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;G</span><span style="color:#ae81ff">\xc3\xbc</span><span style="color:#e6db74">nay&#39;</span>, <span style="color:#ae81ff">20</span>),
 Human(<span style="color:#e6db74">&#39;Cody&#39;</span>, <span style="color:#ae81ff">17</span>)]
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">5</span>):
    <span style="color:#66d9ef">for</span> human <span style="color:#f92672">in</span> humans:
        human<span style="color:#f92672">.</span>have_birthday()

    human <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice(humans)
    classification <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adult&#39;</span> <span style="color:#66d9ef">if</span> is_adult(human) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;minor&#39;</span>
    <span style="color:#66d9ef">print</span> (<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;{} died as a {} at the age of {}.&#39;</span>)<span style="color:#f92672">.</span>format(human<span style="color:#f92672">.</span>name, classification, human<span style="color:#f92672">.</span>age)
    humans<span style="color:#f92672">.</span>remove(human)
</code></pre></div><h2 id="postface">Postface</h2>
<p>The finished unpacker script is available at <a href="https://github.com/Andoryuuta/unpyprotect"><code>https://github.com/Andoryuuta/unpyprotect</code></a>.</p>
<h3 id="resources">Resources</h3>
<ul>
<li><a href="https://snowstar.org/2019/05/09/pyprotect-by-angelic47-decode/">&ldquo;PyProtect By Angelic47 解密&rdquo;</a> article by SnowStar.</li>
<li><a href="https://www.fireeye.com/blog/threat-research/2016/05/deobfuscating_python.html">&ldquo;Deobfuscating Python Bytecode&rdquo;</a> article by FireEye.</li>
<li><a href="https://github.com/rocky/python-xdis/"><code>xdis</code></a>, <a href="https://github.com/rocky/python-xasm/"><code>xasm</code></a>, and <a href="https://github.com/rocky/python-uncompyle6"><code>uncompyle6</code></a> GitHub repos.</li>
<li><a href="https://github.com/fireeye/flare-bytecode_graph"><code>flare-bytecode_graph</code></a> GitHub repo.</li>
</ul>

  </div>
  

<div class="navigation navigation-single">
    
    
    <a href="/posts/diagnosing-an-unsual-wifi-issue/" class="navigation-next">
      <span class="navigation-tittle">Resolving an unusual wifi issue</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/x86asm.min.js"></script>
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/python.min.js"></script>
            
        
    
    <script type="text/javascript">
        
        hljs.configure({languages: ["x86asm, python"]});
        
        hljs.initHighlightingOnLoad();
    </script>
    






    



    </body>
</html>
